<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>ERP Microservices - Deployment &amp; Operations Guide | ERP Microservices Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="ERP Microservices - Deployment &amp; Operations Guide | ERP Microservices Documentation ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/deployment/DEPLOYMENT_OPERATIONS_GUIDE.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="ERP Microservices">
            ERP Microservices
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="erp-microservices---deployment--operations-guide">ERP Microservices - Deployment &amp; Operations Guide</h1>

<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#pre-deployment-checklist">Pre-Deployment Checklist</a></li>
<li><a href="#deployment-architecture">Deployment Architecture</a></li>
<li><a href="#step-by-step-deployment">Step-by-Step Deployment</a></li>
<li><a href="#post-deployment-verification">Post-Deployment Verification</a></li>
<li><a href="#operations--monitoring">Operations &amp; Monitoring</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#maintenance--updates">Maintenance &amp; Updates</a></li>
</ol>
<hr>
<h2 id="pre-deployment-checklist">Pre-Deployment Checklist</h2>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>[ ] Azure Subscription (Owner or Contributor role)</li>
<li>[ ] Azure CLI 2.50+ installed</li>
<li>[ ] PowerShell 5.1+ installed</li>
<li>[ ] Git installed (for version control)</li>
<li>[ ] Network connectivity to Azure</li>
<li>[ ] Sufficient quota in Azure subscription</li>
</ul>
<h3 id="required-permissions">Required Permissions</h3>
<pre><code class="lang-powershell"># Check current user permissions
az role assignment list --assignee (az account show --query user.name -o tsv)

# Verify required roles
# - Contributor (on subscription or resource group)
# - User Access Administrator (for RBAC assignments)
# - Key Vault Administrator (for secrets management)
</code></pre>
<h3 id="environment-preparation">Environment Preparation</h3>
<pre><code class="lang-powershell"># 1. Authenticate to Azure
az login

# 2. Set subscription
az account set --subscription &quot;your-subscription-id&quot;

# 3. Verify subscription
az account show
az account list-locations

# 4. Check CLI version
az --version
az bicep version
</code></pre>
<hr>
<h2 id="deployment-architecture">Deployment Architecture</h2>
<h3 id="resource-creation-order">Resource Creation Order</h3>
<pre><code>1. Resource Group (rg-{environment})
   ↓
2. Core Infrastructure
   ├─ Container Registry (ACR)
   ├─ Log Analytics Workspace
   ├─ Storage Account (file shares)
   ├─ Container Apps Environment
   └─ Network configuration
   ↓
3. Security Infrastructure
   ├─ Key Vault (with purge protection)
   ├─ Key Vault Secrets
   │  ├─ JWT secret key
   │  ├─ Redis password
   │  ├─ SQL passwords
   │  └─ Connection strings
   └─ Managed Identities (8 total)
   ↓
4. Configuration Management
   ├─ App Configuration Store
   ├─ Configuration Key-Values
   └─ Key Vault References
   ↓
5. Data Services
   ├─ SQL Server
   ├─ Databases (6)
   └─ Redis Cache
   ↓
6. Monitoring
   ├─ Application Insights
   └─ Diagnostic Settings
   ↓
7. Microservices (Parallel)
   ├─ Auth Service
   ├─ Billing Service
   ├─ Inventory Service
   ├─ Orders Service
   ├─ Purchasing Service
   ├─ Sales Service
   └─ API Gateway
   ↓
8. RBAC &amp; Security
   ├─ Service → App Configuration RBAC
   ├─ App Configuration → Key Vault RBAC
   └─ All → Container Registry RBAC
</code></pre>
<h3 id="bicep-module-execution-order">Bicep Module Execution Order</h3>
<pre><code class="lang-bicep">1. main.bicep (subscription scope)
   ├─ Create resource group
   ├─ Call resources.bicep (shared services)
   │
   ├─ Call redis.bicep
   ├─ Call sql-server.bicep
   ├─ Call keyvault-secrets.bicep
   │
   ├─ Call app-configuration.bicep
   │
   ├─ Call each service bicep (parallel)
   │  ├─ auth-service.bicep
   │  ├─ billing-service.bicep
   │  ├─ inventory-service.bicep
   │  ├─ orders-service.bicep
   │  ├─ purchasing-service.bicep
   │  ├─ sales-service.bicep
   │  └─ api-gateway.bicep
   │
   └─ Call RBAC modules
      ├─ appconfig-rbac.bicep (×7 services)
      └─ keyvault-rbac.bicep (×1 for App Config)
</code></pre>
<hr>
<h2 id="step-by-step-deployment">Step-by-Step Deployment</h2>
<h3 id="phase-1-parameter-preparation">Phase 1: Parameter Preparation</h3>
<pre><code class="lang-powershell"># ============================================================================
# Step 1: Generate Secure Secrets
# ============================================================================

# Generate JWT Secret (384 bits = very secure)
$jwtSecretKey = [Convert]::ToBase64String(
    [System.Security.Cryptography.RandomNumberGenerator]::GetBytes(48)
)
Write-Host &quot;JWT Secret Key: $jwtSecretKey&quot;

# Generate Redis Cache Password (256 bits)
$cachePassword = [Convert]::ToBase64String(
    [System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32)
)
Write-Host &quot;Cache Password: $cachePassword&quot;

# Generate SQL Admin Password (16+ chars, mixed case, numbers, special chars)
$sqlPassword = &quot;P@$(([System.Guid]::NewGuid()).ToString().Replace('-','').Substring(0,20))!1&quot;
Write-Host &quot;SQL Password: $sqlPassword&quot;

# Save to environment variables (temporary)
$env:JWT_SECRET_KEY = $jwtSecretKey
$env:CACHE_PASSWORD = $cachePassword
$env:SQL_PASSWORD = $sqlPassword

# ============================================================================
# Step 2: Create Parameters File
# ============================================================================

$params = @{
    environmentName         = &quot;prod&quot;
    location                = &quot;eastus&quot;
    jwtSecretKey            = $jwtSecretKey
    cache_password          = $cachePassword
    password                = $sqlPassword
    jwtIssuer               = &quot;MyApp.Auth&quot;
    jwtAudience             = &quot;MyApp.All&quot;
    frontendOrigin          = &quot;https://app.contoso.com;https://www.contoso.com&quot;
    aspnetcoreEnvironment   = &quot;Production&quot;
}

# Save to file
$params | ConvertTo-Json | Out-File &quot;parameters-prod.json&quot;

# ============================================================================
# Step 3: Validate Syntax
# ============================================================================

# Build Bicep to ARM template
az bicep build --file &quot;infra/main.bicep&quot;

# This creates main.json (ARM template)
# File: infra/main.json
</code></pre>
<h3 id="phase-2-validation">Phase 2: Validation</h3>
<pre><code class="lang-powershell"># ============================================================================
# Step 4: Validate Deployment (Dry Run)
# ============================================================================

Write-Host &quot;Starting deployment validation...&quot; -ForegroundColor Cyan

$validationResult = az deployment sub validate `
    --template-file &quot;infra/main.bicep&quot; `
    --parameters &quot;parameters-prod.json&quot; `
    --location &quot;eastus&quot; `
    --output json | ConvertFrom-Json

if ($validationResult.error) {
    Write-Host &quot;❌ Validation FAILED&quot; -ForegroundColor Red
    Write-Host $validationResult.error.details
    exit 1
}

Write-Host &quot;✅ Validation PASSED&quot; -ForegroundColor Green

# ============================================================================
# Step 5: What-If Analysis
# ============================================================================

Write-Host &quot;Starting What-If analysis...&quot; -ForegroundColor Cyan

$whatIfResult = az deployment sub what-if `
    --template-file &quot;infra/main.bicep&quot; `
    --parameters &quot;parameters-prod.json&quot; `
    --location &quot;eastus&quot; `
    --output json | ConvertFrom-Json

Write-Host &quot;Resources to be created:&quot;
$whatIfResult.changes | Where-Object { $_.changeType -eq &quot;Create&quot; } | ForEach-Object {
    Write-Host &quot;  ✓ $($_.resourceId)&quot; -ForegroundColor Green
}

Write-Host &quot;Resources to be modified:&quot;
$whatIfResult.changes | Where-Object { $_.changeType -eq &quot;Modify&quot; } | ForEach-Object {
    Write-Host &quot;  ~ $($_.resourceId)&quot; -ForegroundColor Yellow
}

Write-Host &quot;Resources to be deleted:&quot;
$whatIfResult.changes | Where-Object { $_.changeType -eq &quot;Delete&quot; } | ForEach-Object {
    Write-Host &quot;  ✗ $($_.resourceId)&quot; -ForegroundColor Red
}
</code></pre>
<h3 id="phase-3-deployment">Phase 3: Deployment</h3>
<pre><code class="lang-powershell"># ============================================================================
# Step 6: Deploy Infrastructure
# ============================================================================

$deploymentName = &quot;erp-deployment-$(Get-Date -Format 'yyyyMMdd-HHmmss')&quot;

Write-Host &quot;Starting deployment: $deploymentName&quot; -ForegroundColor Cyan

$deployment = az deployment sub create `
    --template-file &quot;infra/main.bicep&quot; `
    --parameters &quot;parameters-prod.json&quot; `
    --name $deploymentName `
    --location &quot;eastus&quot; `
    --output json | ConvertFrom-Json

if ($deployment.properties.provisioningState -ne &quot;Succeeded&quot;) {
    Write-Host &quot;❌ Deployment FAILED&quot; -ForegroundColor Red
    Write-Host $deployment.properties.error
    exit 1
}

Write-Host &quot;✅ Deployment SUCCEEDED&quot; -ForegroundColor Green

# Save deployment outputs
$outputs = $deployment.properties.outputs
$outputs | ConvertTo-Json | Out-File &quot;deployment-outputs-prod.json&quot;

Write-Host &quot;Outputs saved to deployment-outputs-prod.json&quot;

# ============================================================================
# Step 7: Extract Important Outputs
# ============================================================================

$outputs = $deployment.properties.outputs

$apiGatewayFqdn = $outputs.API_GATEWAY_FQDN.value
$keyVaultName = $outputs.AZURE_KEY_VAULT_NAME.value
$sqlServerName = $outputs.AZURE_SQL_SERVER_NAME.value
$redisHostName = $outputs.AZURE_REDIS_CACHE_HOST.value

Write-Host &quot;
========================================
 Deployment Complete - Important URLs
========================================

API Gateway:       https://$apiGatewayFqdn
Key Vault:         $keyVaultName.vault.azure.net
SQL Server:        $sqlServerName.database.windows.net
Redis Cache:       $redisHostName:6380
App Config:        (search in Azure Portal)

Save these for reference!
========================================
&quot;
</code></pre>
<hr>
<h2 id="post-deployment-verification">Post-Deployment Verification</h2>
<h3 id="phase-4-verify-deployment">Phase 4: Verify Deployment</h3>
<pre><code class="lang-powershell"># ============================================================================
# Step 8: Verify Resources Created
# ============================================================================

$resourceGroup = &quot;rg-prod&quot;

Write-Host &quot;Verifying resource creation...&quot; -ForegroundColor Cyan

# Verify resource group
$rg = az group show -n $resourceGroup -o json | ConvertFrom-Json
Write-Host &quot;✓ Resource Group: $($rg.name)&quot; -ForegroundColor Green

# Verify container apps
$containerApps = az containerapp list -g $resourceGroup -o json | ConvertFrom-Json
Write-Host &quot;✓ Container Apps: $($containerApps.Count) services&quot;
$containerApps | ForEach-Object {
    Write-Host &quot;  - $($_.name) (Replicas: $($_.properties.template.scale.maxReplicas))&quot;
}

# Verify database
$sqlServer = az sql server list -g $resourceGroup -o json | ConvertFrom-Json
if ($sqlServer) {
    Write-Host &quot;✓ SQL Server: $($sqlServer[0].name)&quot;
    $databases = az sql db list -g $resourceGroup -s $sqlServer[0].name -o json | ConvertFrom-Json
    Write-Host &quot;  Databases: $($databases.Count)&quot;
}

# Verify Key Vault
$keyVault = az keyvault list -g $resourceGroup -o json | ConvertFrom-Json
if ($keyVault) {
    Write-Host &quot;✓ Key Vault: $($keyVault[0].name)&quot;
    $secrets = az keyvault secret list --vault-name $keyVault[0].name -o json | ConvertFrom-Json
    Write-Host &quot;  Secrets: $($secrets.Count)&quot;
}

# Verify App Configuration
$appConfig = az appconfig list -g $resourceGroup -o json | ConvertFrom-Json
if ($appConfig) {
    Write-Host &quot;✓ App Configuration: $($appConfig[0].name)&quot;
}

# ============================================================================
# Step 9: Verify RBAC Assignments
# ============================================================================

Write-Host &quot;Verifying RBAC assignments...&quot; -ForegroundColor Cyan

# List all role assignments in resource group
$roleAssignments = az role assignment list `
    --resource-group $resourceGroup `
    --output json | ConvertFrom-Json

Write-Host &quot;Total RBAC assignments: $($roleAssignments.Count)&quot;

# Count by role
$roleAssignments | Group-Object { $_.roleDefinitionName } | ForEach-Object {
    Write-Host &quot;  - $($_.Name): $($_.Count)&quot;
}

# ============================================================================
# Step 10: Verify Secrets in Key Vault
# ============================================================================

$keyVaultName = (az keyvault list -g $resourceGroup --query &quot;[0].name&quot; -o tsv)

Write-Host &quot;Verifying secrets in Key Vault: $keyVaultName&quot; -ForegroundColor Cyan

$secrets = az keyvault secret list --vault-name $keyVaultName -o json | ConvertFrom-Json

$expectedSecrets = @(
    &quot;jwt-secret-key&quot;
    &quot;redis-connection&quot;
    &quot;redis-cache-password&quot;
    &quot;sql-connection-authdb&quot;
    &quot;sql-connection-billingdb&quot;
    &quot;sql-connection-inventorydb&quot;
    &quot;sql-connection-ordersdb&quot;
    &quot;sql-connection-purchasingdb&quot;
    &quot;sql-connection-salesdb&quot;
)

foreach ($secretName in $expectedSecrets) {
    $secret = $secrets | Where-Object { $_.name -eq $secretName }
    if ($secret) {
        Write-Host &quot;  ✓ $secretName&quot; -ForegroundColor Green
    } else {
        Write-Host &quot;  ✗ $secretName&quot; -ForegroundColor Red
    }
}

# ============================================================================
# Step 11: Test Service Connectivity
# ============================================================================

Write-Host &quot;Testing service connectivity...&quot; -ForegroundColor Cyan

# Get API Gateway FQDN
$apiGatewayFqdn = az containerapp show `
    -g $resourceGroup `
    -n &quot;api-gateway&quot; `
    --query &quot;properties.configuration.ingress.fqdn&quot; `
    -o tsv

Write-Host &quot;API Gateway: https://$apiGatewayFqdn&quot;

# Test API Gateway endpoint
$response = Invoke-WebRequest -Uri &quot;https://$apiGatewayFqdn/health&quot; `
    -ErrorAction SilentlyContinue

if ($response.StatusCode -eq 200) {
    Write-Host &quot;  ✓ API Gateway is responding&quot; -ForegroundColor Green
} else {
    Write-Host &quot;  ⚠ API Gateway returned: $($response.StatusCode)&quot; -ForegroundColor Yellow
}
</code></pre>
<hr>
<h2 id="operations--monitoring">Operations &amp; Monitoring</h2>
<h3 id="real-time-logs">Real-Time Logs</h3>
<pre><code class="lang-powershell"># Get logs from a specific service (real-time)
az containerapp logs show `
    -g rg-prod `
    -n auth-service `
    --tail 50 `
    --follow

# Get logs for all services
$services = @(&quot;auth-service&quot;, &quot;billing-service&quot;, &quot;inventory-service&quot;, &quot;orders-service&quot;, &quot;purchasing-service&quot;, &quot;sales-service&quot;, &quot;api-gateway&quot;)

foreach ($service in $services) {
    Write-Host &quot;Logs for $service:&quot; -ForegroundColor Cyan
    az containerapp logs show -g rg-prod -n $service --tail 10
    Write-Host &quot;&quot;
}
</code></pre>
<h3 id="kql-monitoring-queries">KQL Monitoring Queries</h3>
<pre><code class="lang-kusto">// Query 1: Service Error Rate (last 24h)
let duration = 24h;
traces
| where timestamp &gt; ago(duration)
| where severityLevel &gt;= 2  // Warning or Error
| summarize ErrorCount = count() by name, severityLevel
| sort by ErrorCount desc

// Query 2: API Response Times (percentiles)
customMetrics
| where name == &quot;RequestDuration&quot;
| where timestamp &gt; ago(1h)
| summarize 
    P50 = percentile(value, 50),
    P95 = percentile(value, 95),
    P99 = percentile(value, 99)
    by operation_Name

// Query 3: External Dependencies Health
dependencies
| where timestamp &gt; ago(1h)
| summarize 
    TotalCalls = count(),
    FailedCalls = count(success == false)
    by name, type
| extend SuccessRate = (TotalCalls - FailedCalls) * 100.0 / TotalCalls
| where SuccessRate &lt; 99

// Query 4: Service-to-Service Call Latency
customEvents
| where name == &quot;ServiceInvocation&quot;
| where timestamp &gt; ago(1h)
| summarize 
    AvgLatency = avg(todouble(customMeasurements.latency_ms)),
    MaxLatency = max(todouble(customMeasurements.latency_ms))
    by customDimensions.source_service, customDimensions.target_service
</code></pre>
<h3 id="health-check-endpoints">Health Check Endpoints</h3>
<pre><code class="lang-bash"># Check API Gateway health
curl -X GET https://{api-gateway-fqdn}/health

# Check service health
curl -X GET https://{api-gateway-fqdn}/auth/health
curl -X GET https://{api-gateway-fqdn}/billing/health
curl -X GET https://{api-gateway-fqdn}/inventory/health
# etc.

# Expected Response
{
  &quot;status&quot;: &quot;Healthy&quot;,
  &quot;checks&quot;: {
    &quot;database&quot;: &quot;Healthy&quot;,
    &quot;redis&quot;: &quot;Healthy&quot;,
    &quot;keyvault&quot;: &quot;Healthy&quot;
  }
}
</code></pre>
<hr>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="common-issues--solutions">Common Issues &amp; Solutions</h3>
<table>
<thead>
<tr>
<th>Issue</th>
<th>Symptoms</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Services won't start</strong></td>
<td>Pods keep crashing</td>
<td>Check container logs: <code>az containerapp logs show</code></td>
</tr>
<tr>
<td><strong>Key Vault access denied</strong></td>
<td>403 Forbidden errors</td>
<td>Verify RBAC: <code>az role assignment list</code></td>
</tr>
<tr>
<td><strong>Database connection failed</strong></td>
<td>App crashes at startup</td>
<td>Check connection string in App Config</td>
</tr>
<tr>
<td><strong>Redis connection timeout</strong></td>
<td>Cache operations fail</td>
<td>Verify Redis password, check firewall</td>
</tr>
<tr>
<td><strong>JWT validation fails</strong></td>
<td>401 Unauthorized on API calls</td>
<td>Verify JWT secret in Key Vault matches signing key</td>
</tr>
<tr>
<td><strong>Configuration not updating</strong></td>
<td>Old config persists</td>
<td>Clear service cache, check App Config labels</td>
</tr>
<tr>
<td><strong>High memory usage</strong></td>
<td>Service memory exceeds limits</td>
<td>Check for memory leaks, scale up memory allocation</td>
</tr>
<tr>
<td><strong>Slow API responses</strong></td>
<td>Request latency &gt; 500ms</td>
<td>Check database query performance, Redis cache hit rate</td>
</tr>
</tbody>
</table>
<h3 id="debug-commands">Debug Commands</h3>
<pre><code class="lang-powershell"># 1. Check service status
az containerapp show -g rg-prod -n auth-service `
    --query &quot;properties.runningStatus&quot; -o table

# 2. View provisioning errors
az containerapp show -g rg-prod -n auth-service `
    --query &quot;properties.deploymentStatus&quot; -o json

# 3. Check container registry access
az acr check-health -n {acrName} --ignore-errors

# 4. Verify managed identity
az identity show -g rg-prod -n auth-service-mi

# 5. Test Key Vault access
az keyvault secret show `
    --vault-name {vaultName} `
    --name jwt-secret-key

# 6. Check App Configuration values
az appconfig kv list `
    --name {configStoreName} `
    --all

# 7. Monitor scaling events
az monitor metrics list `
    --resource-group rg-prod `
    --resource-type &quot;Microsoft.App/containerApps&quot; `
    --resource auth-service `
    --metric ReplicaCount `
    --start-time (Get-Date).AddHours(-1) `
    --interval PT1M
</code></pre>
<hr>
<h2 id="maintenance--updates">Maintenance &amp; Updates</h2>
<h3 id="regular-maintenance-tasks">Regular Maintenance Tasks</h3>
<pre><code class="lang-powershell"># ============================================================================
# Weekly Tasks
# ============================================================================

# Review error logs
$errorCount = az monitor metrics list `
    --resource-group rg-prod `
    --resource-type &quot;Microsoft.App/containerApps&quot; `
    --metric ErrorCount `
    --start-time (Get-Date).AddDays(-7) `
    --aggregation Total

# Check Key Vault secret expiration (manual tracking)
Write-Host &quot;Check Key Vault secrets last updated:&quot;
az keyvault secret list `
    --vault-name {vaultName} `
    --query &quot;[].attributes.updated&quot;

# ============================================================================
# Monthly Tasks
# ============================================================================

# Rotate secrets (manual process)
# 1. Generate new JWT secret
$newJwtSecret = [Convert]::ToBase64String(
    [System.Security.Cryptography.RandomNumberGenerator]::GetBytes(48)
)

# 2. Update Key Vault
az keyvault secret set `
    --vault-name {vaultName} `
    --name jwt-secret-key `
    --value $newJwtSecret

# 3. Services auto-refresh from App Config

# Review performance metrics
az monitor metrics list `
    --resource-group rg-prod `
    --metric &quot;AverageResponseTime&quot; `
    --start-time (Get-Date).AddMonths(-1)

# ============================================================================
# Quarterly Tasks
# ============================================================================

# Review RBAC assignments
az role assignment list --resource-group rg-prod

# Update Azure CLI and Bicep
az upgrade
az bicep upgrade

# Review backup/disaster recovery
az backup vault list -g rg-prod
</code></pre>
<h3 id="updating-services">Updating Services</h3>
<pre><code class="lang-powershell"># ============================================================================
# Update Container Image
# ============================================================================

# 1. Build new image
docker build -t {acrName}.azurecr.io/auth-service:v2.0 .

# 2. Push to ACR
docker push {acrName}.azurecr.io/auth-service:v2.0

# 3. Update container app
az containerapp update `
    -g rg-prod `
    -n auth-service `
    --image {acrName}.azurecr.io/auth-service:v2.0

# 4. Monitor rollout
az containerapp logs show -g rg-prod -n auth-service --follow
</code></pre>
<h3 id="updating-infrastructure-bicep">Updating Infrastructure (Bicep)</h3>
<pre><code class="lang-powershell"># ============================================================================
# Update Bicep Templates
# ============================================================================

# 1. Modify Bicep files
# Example: Update redis capacity in redis.bicep

# 2. Validate changes
az bicep build --file infra/main.bicep
az deployment sub validate `
    --template-file infra/main.bicep `
    --parameters parameters-prod.json `
    --location eastus

# 3. Preview What-If
az deployment sub what-if `
    --template-file infra/main.bicep `
    --parameters parameters-prod.json `
    --location eastus

# 4. Deploy updates
az deployment sub create `
    --template-file infra/main.bicep `
    --parameters parameters-prod.json `
    --name &quot;erp-update-$(Get-Date -Format 'yyyyMMdd-HHmmss')&quot; `
    --location eastus
</code></pre>
<hr>
<h2 id="appendix-quick-reference">Appendix: Quick Reference</h2>
<h3 id="common-deployment-scenarios">Common Deployment Scenarios</h3>
<pre><code class="lang-powershell"># Scenario 1: Fresh Production Deployment
.\scripts\deploy-prod.ps1

# Scenario 2: Deploy to Staging
.\scripts\deploy-staging.ps1

# Scenario 3: Rolling Update of Single Service
.\scripts\update-service.ps1 -Service &quot;auth-service&quot; -ImageTag &quot;v2.0&quot;

# Scenario 4: Scale Up During Peak Hours
az containerapp update -g rg-prod -n auth-service `
    --min-replicas 3 --max-replicas 20

# Scenario 5: Rollback to Previous Deployment
az deployment group deployment-operation list `
    -g rg-prod `
    --deployment-name {previous-deployment-name}
</code></pre>
<h3 id="emergency-commands">Emergency Commands</h3>
<pre><code class="lang-powershell"># Stop a malfunctioning service
az containerapp update -g rg-prod -n {service-name} `
    --min-replicas 0 --max-replicas 1

# Restart a service
az containerapp revision deactivate -g rg-prod -n {service-name}

# Clear application cache
az redis-cli -g rg-prod -n {redis-name} FLUSHALL

# Force sync App Configuration
# (Services check every 30s by default)

# Drain connections before maintenance
# Update API Gateway routing rules temporarily
</code></pre>
<hr>
<p><strong>Document Version:</strong> 1.0<br>
<strong>Last Updated:</strong> 2024-10-27<br>
<strong>Status:</strong> ✅ Production Ready</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/deployment/DEPLOYMENT_OPERATIONS_GUIDE.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          ERP Microservices - A cloud-native ERP system built with .NET 9
        </div>
      </div>
    </footer>
  </body>
</html>
