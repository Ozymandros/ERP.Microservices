<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>PLANTILLAS PARA M&#211;DULOS BICEP FALTANTES | ERP Microservices Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="PLANTILLAS PARA M&#211;DULOS BICEP FALTANTES | ERP Microservices Documentation ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/infrastructure/BICEP_TEMPLATES.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="ERP Microservices">
            ERP Microservices
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="plantillas-para-módulos-bicep-faltantes">PLANTILLAS PARA MÓDULOS BICEP FALTANTES</h1>

<h2 id="1-estructura-general-para-servicios">1. Estructura general para servicios</h2>
<p>Todos los servicios siguen el mismo patrón. Usa esta plantilla como base.</p>
<hr>
<h2 id="-plantilla-service-module">📦 PLANTILLA: Service Module</h2>
<p>Nombre: <code>infra/{service-name}/{service-name}.module.bicep</code></p>
<pre><code class="lang-bicep">@description('Location for the resources')
param location string

@description('Tags for all resources')
param tags object = {}

@description('Container Apps Environment Name')
param containerAppsEnvironmentName string

@description('Container Registry Name')
param containerRegistryName string

@description('Managed Identity ID')
param managedIdentityId string

@description('SQL Server FQDN')
param sqlServerFqdn string

@description('SQL Server Admin Name')
param sqlServerAdminName string

@description('Redis hostname')
param redisHostName string

@description('Redis SSL port')
param redisSslPort int = 6379

@description('Redis password')
@secure()
param redisPrimaryKey string

@description('Application Insights Connection String')
param appInsightsConnectionString string

@description('JWT Secret Key')
@secure()
param jwtSecretKey string

@description('JWT Issuer')
param jwtIssuer string

@description('JWT Audience')
param jwtAudience string

@description('Frontend Origin for CORS')
param frontendOrigin string = 'https://localhost:3000'

@description('Service name (e.g., auth, billing, inventory)')
param serviceName string

@description('Database name for this service')
param databaseName string

@description('Container image name')
param imageName string

@description('Min replicas for autoscaling')
param minReplicas int = 2

@description('Max replicas for autoscaling')
param maxReplicas int = 5

@description('Port exposed by the container')
param containerPort int = 8080

// Resource references
resource containerAppsEnvironment 'Microsoft.App/managedEnvironments@2023-05-01' existing = {
  name: containerAppsEnvironmentName
}

resource containerRegistry 'Microsoft.ContainerRegistry/registries@2023-01-01-preview' existing = {
  name: containerRegistryName
}

resource sqlServer 'Microsoft.Sql/servers@2023-08-01' existing = {
  name: split(sqlServerFqdn, '.')[0]
}

resource sqlDatabase 'Microsoft.Sql/servers/databases@2023-08-01' existing = {
  parent: sqlServer
  name: databaseName
}

// Build connection string
var connectionString = 'Server=tcp:${sqlServerFqdn},1433;Initial Catalog=${databaseName};Persist Security Info=False;Authentication=Active Directory Default;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;'

// Redis connection string
var redisConnectionString = '${redisHostName}:${redisSslPort},password=${redisPrimaryKey},ssl=True'

// Container App
resource containerApp 'Microsoft.App/containerApps@2024-02-02-preview' = {
  name: '${serviceName}-service'
  location: location
  tags: tags
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    managedEnvironmentId: containerAppsEnvironment.id
    configuration: {
      ingress: {
        external: false  // Internal only, traffic through Gateway
        targetPort: containerPort
        transport: 'auto'
        allowInsecure: false
      }
      registries: [
        {
          server: containerRegistry.properties.loginServer
          identity: 'system-assigned'
        }
      ]
      secrets: [
        {
          name: 'connection-string'
          value: connectionString
        }
        {
          name: 'redis-connection-string'
          value: redisConnectionString
        }
        {
          name: 'jwt-secret-key'
          value: jwtSecretKey
        }
        {
          name: 'app-insights-connection-string'
          value: appInsightsConnectionString
        }
      ]
    }
    template: {
      containers: [
        {
          name: serviceName
          image: '${containerRegistry.properties.loginServer}/${imageName}'
          resources: {
            cpu: json('1.0')
            memory: '2.0Gi'
          }
          env: [
            {
              name: 'ASPNETCORE_ENVIRONMENT'
              value: 'Production'
            }
            {
              name: 'ASPNETCORE_URLS'
              value: 'http://+:${containerPort}'
            }
            {
              name: 'ConnectionStrings__DefaultConnection'
              secretRef: 'connection-string'
            }
            {
              name: 'Redis__ConnectionString'
              secretRef: 'redis-connection-string'
            }
            {
              name: 'Jwt__SecretKey'
              secretRef: 'jwt-secret-key'
            }
            {
              name: 'Jwt__Issuer'
              value: jwtIssuer
            }
            {
              name: 'Jwt__Audience'
              value: jwtAudience
            }
            {
              name: 'APPLICATIONINSIGHTS_CONNECTION_STRING'
              secretRef: 'app-insights-connection-string'
            }
            {
              name: 'ApplicationInsightsAgent_EXTENSION_VERSION'
              value: '~3'
            }
            {
              name: 'FRONTEND_ORIGIN'
              value: frontendOrigin
            }
          ]
          probes: [
            {
              type: 'Liveness'
              httpGet: {
                path: '/health'
                port: containerPort
                scheme: 'HTTP'
              }
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 5
              failureThreshold: 3
            }
            {
              type: 'Readiness'
              httpGet: {
                path: '/health'
                port: containerPort
                scheme: 'HTTP'
              }
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 3
              failureThreshold: 3
            }
          ]
        }
      ]
      scale: {
        minReplicas: minReplicas
        maxReplicas: maxReplicas
        rules: [
          {
            name: 'http-scaling-rule'
            http: {
              metadata: {
                concurrentRequests: '100'
              }
            }
          }
        ]
      }
    }
  }
}

// Grant this service access to ACR
resource acrPullRole 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(containerApp.id, containerRegistry.id, 'acrpull')
  scope: containerRegistry
  properties: {
    principalId: containerApp.identity.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')
  }
}

// Grant this service access to SQL Server database
resource sqlDatabaseReaderRole 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(sqlDatabase.id, containerApp.identity.principalId, 'db-reader')
  scope: sqlDatabase
  properties: {
    principalId: containerApp.identity.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c12c1926-28b6-475e-b378-a00be61cc639')
  }
}

output id string = containerApp.id
output name string = containerApp.name
output fqdn string = containerApp.properties.configuration.ingress.fqdn
output internalFqdn string = 'https://${serviceName}-service.internal.${containerAppsEnvironment.properties.defaultDomain}'
</code></pre>
<hr>
<h2 id="-plantilla-api-gateway-module">🔌 PLANTILLA: API Gateway Module</h2>
<p>Nombre: <code>infra/api-gateway/api-gateway.module.bicep</code></p>
<pre><code class="lang-bicep">@description('Location for the resources')
param location string

@description('Tags for all resources')
param tags object = {}

@description('Container Apps Environment Name')
param containerAppsEnvironmentName string

@description('Container Registry Name')
param containerRegistryName string

@description('Managed Identity ID')
param managedIdentityId string

@description('Application Insights Connection String')
param appInsightsConnectionString string

@description('Container image name')
param imageName string = 'erpapigateway:latest'

@description('Min replicas for autoscaling')
param minReplicas int = 2

@description('Max replicas for autoscaling')
param maxReplicas int = 5

// Resource references
resource containerAppsEnvironment 'Microsoft.App/managedEnvironments@2023-05-01' existing = {
  name: containerAppsEnvironmentName
}

resource containerRegistry 'Microsoft.ContainerRegistry/registries@2023-01-01-preview' existing = {
  name: containerRegistryName
}

// API Gateway Container App
resource containerApp 'Microsoft.App/containerApps@2024-02-02-preview' = {
  name: 'api-gateway'
  location: location
  tags: tags
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    managedEnvironmentId: containerAppsEnvironment.id
    configuration: {
      ingress: {
        external: true  // This is the public entry point
        targetPort: 8080
        transport: 'auto'
        allowInsecure: false
        corsPolicy: {
          allowCredentials: true
          allowedHeaders: ['*']
          allowedHttpMethods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
          allowedOrigins: ['*']  // Restrict in production
          exposeHeaders: ['*']
          maxAge: 3600
        }
      }
      registries: [
        {
          server: containerRegistry.properties.loginServer
          identity: 'system-assigned'
        }
      ]
      secrets: [
        {
          name: 'app-insights-connection-string'
          value: appInsightsConnectionString
        }
      ]
    }
    template: {
      containers: [
        {
          name: 'gateway'
          image: '${containerRegistry.properties.loginServer}/${imageName}'
          resources: {
            cpu: json('1.0')
            memory: '2.0Gi'
          }
          env: [
            {
              name: 'ASPNETCORE_ENVIRONMENT'
              value: 'Production'
            }
            {
              name: 'ASPNETCORE_URLS'
              value: 'http://+:8080'
            }
            {
              name: 'OCELOT_ENVIRONMENT'
              value: 'Production'
            }
            {
              name: 'APPLICATIONINSIGHTS_CONNECTION_STRING'
              secretRef: 'app-insights-connection-string'
            }
            {
              name: 'ApplicationInsightsAgent_EXTENSION_VERSION'
              value: '~3'
            }
          ]
          probes: [
            {
              type: 'Liveness'
              httpGet: {
                path: '/health'
                port: 8080
                scheme: 'HTTP'
              }
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 5
              failureThreshold: 3
            }
            {
              type: 'Readiness'
              httpGet: {
                path: '/health'
                port: 8080
                scheme: 'HTTP'
              }
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 3
              failureThreshold: 3
            }
          ]
        }
      ]
      scale: {
        minReplicas: minReplicas
        maxReplicas: maxReplicas
        rules: [
          {
            name: 'http-scaling-rule'
            http: {
              metadata: {
                concurrentRequests: '100'
              }
            }
          }
        ]
      }
    }
  }
}

// Grant this service access to ACR
resource acrPullRole 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(containerApp.id, containerRegistry.id, 'acrpull')
  scope: containerRegistry
  properties: {
    principalId: containerApp.identity.principalId
    principalType: 'ServicePrincipal'
    roleDefinitionId: subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')
  }
}

output id string = containerApp.id
output name string = containerApp.name
output fqdn string = containerApp.properties.configuration.ingress.fqdn
output url string = 'https://${containerApp.properties.configuration.ingress.fqdn}'
</code></pre>
<hr>
<h2 id="-plantilla-application-insights-module">📊 PLANTILLA: Application Insights Module</h2>
<p>Nombre: <code>infra/MyApp-ApplicationInsights/MyApp-ApplicationInsights.module.bicep</code></p>
<pre><code class="lang-bicep">@description('Location for Application Insights')
param location string

@description('Log Analytics Workspace ID')
param workspaceId string

@description('Resource tags')
param tags object = {}

resource applicationInsights 'Microsoft.Insights/components@2020-02-02' = {
  name: 'appins-${uniqueString(resourceGroup().id)}'
  location: location
  kind: 'web'
  tags: tags
  properties: {
    Application_Type: 'web'
    RetentionInDays: 30
    WorkspaceResourceId: workspaceId
    IngestionMode: 'LogAnalytics'
    publicNetworkAccessForIngestion: 'Enabled'
    publicNetworkAccessForQuery: 'Enabled'
  }
}

output appInsightsId string = applicationInsights.id
output appInsightsName string = applicationInsights.name
output appInsightsConnectionString string = applicationInsights.properties.ConnectionString
output appInsightsInstrumentationKey string = applicationInsights.properties.InstrumentationKey
</code></pre>
<hr>
<h2 id="-plantilla-log-analytics-module">📊 PLANTILLA: Log Analytics Module</h2>
<p>Nombre: <code>infra/MyApp-LogAnalyticsWorkspace/MyApp-LogAnalyticsWorkspace.module.bicep</code></p>
<pre><code class="lang-bicep">@description('Location for Log Analytics Workspace')
param location string

@description('Resource tags')
param tags object = {}

resource logAnalyticsWorkspace 'Microsoft.OperationalInsights/workspaces@2022-10-01' = {
  name: 'law-${uniqueString(resourceGroup().id)}'
  location: location
  tags: tags
  properties: {
    sku: {
      name: 'PerGB2018'
    }
    retentionInDays: 30
    publicNetworkAccessForIngestion: 'Enabled'
    publicNetworkAccessForQuery: 'Enabled'
  }
}

output logAnalyticsWorkspaceId string = logAnalyticsWorkspace.id
output logAnalyticsWorkspaceName string = logAnalyticsWorkspace.name
output customerId string = logAnalyticsWorkspace.properties.customerId
</code></pre>
<hr>
<h2 id="-plantilla-sql-server-roles-module">🔐 PLANTILLA: SQL Server Roles Module</h2>
<p>Nombre: <code>infra/myapp-sqlserver-roles/myapp-sqlserver-roles.module.bicep</code></p>
<pre><code class="lang-bicep">@description('SQL Server name')
param sqlServerName string

@description('SQL Server Admin Managed Identity Name')
param sqlServerAdminName string

@description('Principal ID (Managed Identity) of Container Apps')
param principalId string

@description('Principal Name for display')
param principalName string

@description('Location')
param location string = resourceGroup().location

// SQL Server reference
resource sqlServer 'Microsoft.Sql/servers@2023-08-01' existing = {
  name: sqlServerName
}

// Create contained user for the managed identity
resource sqlServerAdministrator 'Microsoft.Sql/servers/administrators@2023-08-01' = {
  parent: sqlServer
  name: 'ActiveDirectory'
  properties: {
    administratorType: 'ActiveDirectory'
    login: principalName
    sid: principalId
    tenantId: subscription().tenantId
  }
}

output adminName string = sqlServerAdministrator.name
</code></pre>
<hr>
<h2 id="-comandos-para-implementar">📝 COMANDOS PARA IMPLEMENTAR</h2>
<h3 id="1-crear-estructura-de-carpetas">1. Crear estructura de carpetas</h3>
<pre><code class="lang-powershell"># Crear carpetas para módulos de servicios
$services = @('auth-service', 'billing-service', 'inventory-service', 'orders-service', 'purchasing-service', 'sales-service')
foreach ($service in $services) {
    New-Item -ItemType Directory -Path &quot;infra/$service&quot; -Force
}

# Crear carpetas faltantes
New-Item -ItemType Directory -Path &quot;infra/MyApp-ApplicationInsights&quot; -Force
New-Item -ItemType Directory -Path &quot;infra/MyApp-LogAnalyticsWorkspace&quot; -Force
New-Item -ItemType Directory -Path &quot;infra/myapp-sqlserver-roles&quot; -Force
</code></pre>
<h3 id="2-copiar-plantillas">2. Copiar plantillas</h3>
<p>Usa los templates anteriores para crear cada módulo <code>.bicep</code></p>
<h3 id="3-actualizar-mainbicep">3. Actualizar main.bicep</h3>
<p>Agregar módulos en <code>main.bicep</code> (ver documento siguiente)</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/infrastructure/BICEP_TEMPLATES.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          ERP Microservices - A cloud-native ERP system built with .NET 9
        </div>
      </div>
    </footer>
  </body>
</html>
