<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>ERP Microservices Infrastructure Architecture Documentation | ERP Microservices Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="ERP Microservices Infrastructure Architecture Documentation | ERP Microservices Documentation ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/architecture/ARCHITECTURE_DOCUMENTATION.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="ERP Microservices">
            ERP Microservices
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="erp-microservices-infrastructure-architecture-documentation">ERP Microservices Infrastructure Architecture Documentation</h1>

<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#infrastructure-components">Infrastructure Components</a></li>
<li><a href="#security-architecture">Security Architecture</a></li>
<li><a href="#data-flow">Data Flow</a></li>
<li><a href="#deployment-topology">Deployment Topology</a></li>
<li><a href="#service-communication">Service Communication</a></li>
<li><a href="#scaling--performance">Scaling &amp; Performance</a></li>
<li><a href="#disaster-recovery">Disaster Recovery</a></li>
<li><a href="#implementation-details">Implementation Details</a></li>
</ol>
<hr>
<h2 id="executive-summary">Executive Summary</h2>
<p>This document describes the complete infrastructure architecture for the <strong>ERP Microservices Platform</strong> deployed on Azure using Bicep Infrastructure-as-Code templates.</p>
<h3 id="key-metrics">Key Metrics</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Microservices</strong></td>
<td>7 (Auth, Billing, Inventory, Orders, Purchasing, Sales) + 1 API Gateway</td>
</tr>
<tr>
<td><strong>Deployment Model</strong></td>
<td>Azure Container Apps (serverless)</td>
</tr>
<tr>
<td><strong>Availability</strong></td>
<td>99.99% (across all managed services)</td>
</tr>
<tr>
<td><strong>Auto-Scaling</strong></td>
<td>Min 1 - Max 10 replicas per service</td>
</tr>
<tr>
<td><strong>Security Model</strong></td>
<td>Zero Trust with Managed Identities + RBAC</td>
</tr>
<tr>
<td><strong>Databases</strong></td>
<td>1 SQL Server with 6 microservice databases</td>
</tr>
<tr>
<td><strong>Cache</strong></td>
<td>Azure Redis Cache (Standard tier)</td>
</tr>
<tr>
<td><strong>Secret Management</strong></td>
<td>Azure Key Vault (centralized)</td>
</tr>
<tr>
<td><strong>Configuration Management</strong></td>
<td>Azure App Configuration (with Key Vault references)</td>
</tr>
<tr>
<td><strong>Monitoring</strong></td>
<td>Azure Log Analytics + Application Insights</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="architecture-overview">Architecture Overview</h2>
<h3 id="high-level-system-architecture">High-Level System Architecture</h3>
<pre><code class="lang-mermaid">graph TB
    subgraph &quot;Client Layer&quot;
        WEB[&quot;ğŸŒ Web Frontend&lt;br/&gt;(React/Angular)&quot;]
        MOBILE[&quot;ğŸ“± Mobile App&quot;]
    end
    
    subgraph &quot;API Gateway&quot;
        GATEWAY[&quot;ğŸšª API Gateway&lt;br/&gt;(Ocelot)&lt;br/&gt;Container App&quot;]
    end
    
    subgraph &quot;Microservices Layer&quot;
        AUTH[&quot;ğŸ” Auth Service&lt;br/&gt;Container App&quot;]
        BILLING[&quot;ğŸ’° Billing Service&lt;br/&gt;Container App&quot;]
        INVENTORY[&quot;ğŸ“¦ Inventory Service&lt;br/&gt;Container App&quot;]
        ORDERS[&quot;ğŸ“‹ Orders Service&lt;br/&gt;Container App&quot;]
        PURCHASING[&quot;ğŸ›’ Purchasing Service&lt;br/&gt;Container App&quot;]
        SALES[&quot;ğŸ’¸ Sales Service&lt;br/&gt;Container App&quot;]
    end
    
    subgraph &quot;Data Layer&quot;
        REDIS[&quot;âš¡ Redis Cache&lt;br/&gt;(Distributed Cache)&quot;]
        SQLDB[&quot;ğŸ—„ï¸ SQL Server&lt;br/&gt;(6 Databases)&quot;]
    end
    
    subgraph &quot;Security &amp; Config&quot;
        KEYVAULT[&quot;ğŸ”‘ Key Vault&lt;br/&gt;(Secrets)&quot;]
        APPCONFIG[&quot;âš™ï¸ App Configuration&lt;br/&gt;(Settings + KV Refs)&quot;]
    end
    
    subgraph &quot;Monitoring&quot;
        LOGS[&quot;ğŸ“Š Log Analytics&quot;]
        INSIGHTS[&quot;ğŸ” App Insights&quot;]
    end
    
    WEB --&gt; GATEWAY
    MOBILE --&gt; GATEWAY
    
    GATEWAY --&gt; AUTH
    GATEWAY --&gt; BILLING
    GATEWAY --&gt; INVENTORY
    GATEWAY --&gt; ORDERS
    GATEWAY --&gt; PURCHASING
    GATEWAY --&gt; SALES
    
    AUTH --&gt; SQLDB
    BILLING --&gt; SQLDB
    INVENTORY --&gt; SQLDB
    ORDERS --&gt; SQLDB
    PURCHASING --&gt; SQLDB
    SALES --&gt; SQLDB
    
    AUTH --&gt; REDIS
    BILLING --&gt; REDIS
    INVENTORY --&gt; REDIS
    ORDERS --&gt; REDIS
    PURCHASING --&gt; REDIS
    SALES --&gt; REDIS
    
    AUTH -.-&gt;|reads| APPCONFIG
    BILLING -.-&gt;|reads| APPCONFIG
    INVENTORY -.-&gt;|reads| APPCONFIG
    ORDERS -.-&gt;|reads| APPCONFIG
    PURCHASING -.-&gt;|reads| APPCONFIG
    SALES -.-&gt;|reads| APPCONFIG
    
    APPCONFIG -.-&gt;|via MI| KEYVAULT
    GATEWAY -.-&gt;|logs| LOGS
    AUTH -.-&gt;|logs| LOGS
    BILLING -.-&gt;|logs| LOGS
    INVENTORY -.-&gt;|logs| LOGS
    ORDERS -.-&gt;|logs| LOGS
    PURCHASING -.-&gt;|logs| LOGS
    SALES -.-&gt;|logs| LOGS
    
    GATEWAY -.-&gt;|events| INSIGHTS
    AUTH -.-&gt;|events| INSIGHTS
    
    style GATEWAY fill:#FFB6C1
    style AUTH fill:#87CEEB
    style BILLING fill:#87CEEB
    style INVENTORY fill:#87CEEB
    style ORDERS fill:#87CEEB
    style PURCHASING fill:#87CEEB
    style SALES fill:#87CEEB
    style REDIS fill:#90EE90
    style SQLDB fill:#FFD700
    style KEYVAULT fill:#FFA500
    style APPCONFIG fill:#FFA500
    style LOGS fill:#DDA0DD
    style INSIGHTS fill:#DDA0DD
</code></pre>
<hr>
<h2 id="infrastructure-components">Infrastructure Components</h2>
<h3 id="1-container-apps-environment">1. Container Apps Environment</h3>
<p><strong>Purpose:</strong> Serverless container hosting platform for microservices</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">â”œâ”€ Managed Environment (CAE)
â”‚  â”œâ”€ Workload Profiles: Consumption (auto-scaling)
â”‚  â”œâ”€ App Logs: Log Analytics integration
â”‚  â”œâ”€ Aspire Dashboard: Built-in
â”‚  â””â”€ Storage Mounts: Azure Files (persistent)
â”‚
â””â”€ Container Apps (8 total)
   â”œâ”€ API Gateway (1x)
   â”œâ”€ Auth Service (1x)
   â”œâ”€ Billing Service (1x)
   â”œâ”€ Inventory Service (1x)
   â”œâ”€ Orders Service (1x)
   â”œâ”€ Purchasing Service (1x)
   â”œâ”€ Sales Service (1x)
   â””â”€ Per Service:
      â”œâ”€ CPU: 0.5 cores
      â”œâ”€ Memory: 1 GB
      â”œâ”€ Replicas: 1-10 (auto-scaling)
      â”œâ”€ Ingress: Internal/External
      â”œâ”€ Dapr: Enabled
      â”œâ”€ System-Assigned MI: Enabled
      â””â”€ Environment Variables: 15-20 per service
</code></pre>
<p><strong>File:</strong> <code>core/host/container-app.bicep</code></p>
<h3 id="2-database-infrastructure">2. Database Infrastructure</h3>
<h4 id="sql-server">SQL Server</h4>
<p><strong>Purpose:</strong> Relational data storage for all microservices</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Azure SQL Server
â”œâ”€ SKU: SQL Server 2022
â”œâ”€ TLS: Minimum 1.2
â”œâ”€ Admin User: sqladmin (Azure AD + SQL Auth)
â”œâ”€ Backup: Automatic retention
â”‚
â””â”€ Databases (6 total)
   â”œâ”€ AuthDB (Users, Roles, Tokens)
   â”œâ”€ BillingDB (Invoices, Payments, Reports)
   â”œâ”€ InventoryDB (Products, Stock, Warehouses)
   â”œâ”€ OrdersDB (Orders, Items, Tracking)
   â”œâ”€ PurchasingDB (POs, Suppliers, Receipts)
   â””â”€ SalesDB (Transactions, Customers, Reports)
</code></pre>
<p><strong>File:</strong> <code>core/database/sql-server.bicep</code></p>
<h4 id="redis-cache">Redis Cache</h4>
<p><strong>Purpose:</strong> Distributed caching layer for session management, distributed locks</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Azure Redis Cache
â”œâ”€ Tier: Standard
â”œâ”€ Capacity: 1 GB
â”œâ”€ SKU Family: C (Clustered)
â”œâ”€ TLS: Enforced (port 6380)
â”œâ”€ Authentication: Enabled (requireauth: true)
â”œâ”€ Max Memory Policy: allkeys-lru (evict oldest)
â”‚
â””â”€ Use Cases:
   â”œâ”€ Distributed Session State
   â”œâ”€ Distributed Locks (coordination)
   â”œâ”€ Caching Query Results
   â””â”€ Rate Limiting
</code></pre>
<p><strong>File:</strong> <code>core/database/redis.bicep</code></p>
<h3 id="3-security-infrastructure">3. Security Infrastructure</h3>
<h4 id="azure-key-vault">Azure Key Vault</h4>
<p><strong>Purpose:</strong> Centralized secrets and cryptographic keys storage</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Key Vault
â”œâ”€ SKU: Standard
â”œâ”€ Access: RBAC + Access Policies
â”œâ”€ Network: Public (with firewall)
â”œâ”€ Purge Protection: Enabled
â”œâ”€ Soft Delete: Enabled (90 days)
â”‚
â””â”€ Stored Secrets (9 total)
   â”œâ”€ jwt-secret-key (JWT signing)
   â”œâ”€ redis-connection (Connection string with password)
   â”œâ”€ redis-cache-password (Authentication password)
   â”œâ”€ sql-connection-authdb (AuthDB connection)
   â”œâ”€ sql-connection-billingdb (BillingDB connection)
   â”œâ”€ sql-connection-inventorydb (InventoryDB connection)
   â”œâ”€ sql-connection-ordersdb (OrdersDB connection)
   â”œâ”€ sql-connection-purchasingdb (PurchasingDB connection)
   â””â”€ sql-connection-salesdb (SalesDB connection)
</code></pre>
<p><strong>File:</strong> <code>core/security/keyvault-secrets.bicep</code></p>
<h4 id="azure-app-configuration">Azure App Configuration</h4>
<p><strong>Purpose:</strong> Centralized configuration and feature flags with Key Vault integration</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">App Configuration Store
â”œâ”€ SKU: Standard
â”œâ”€ Access: RBAC + Access Keys
â”œâ”€ Managed Identity: System-assigned
â”‚
â””â”€ Configuration Keys (20+ total)
   â”œâ”€ Non-Sensitive Settings
   â”‚  â”œâ”€ Jwt:Issuer (e.g., &quot;MyApp.Auth&quot;)
   â”‚  â”œâ”€ Jwt:Audience (e.g., &quot;MyApp.All&quot;)
   â”‚  â”œâ”€ Frontend:Origin (CORS)
   â”‚  â””â”€ ASPNETCORE_ENVIRONMENT (dev/prod)
   â”‚
   â””â”€ Key Vault References (resolved at runtime)
      â”œâ”€ Jwt:SecretKey â†’ kv:jwt-secret-key
      â”œâ”€ Redis:Connection â†’ kv:redis-connection
      â”œâ”€ Redis:Password â†’ kv:redis-cache-password
      â”œâ”€ Sql:ConnectionStrings:AuthDb â†’ kv:sql-connection-authdb
      â”œâ”€ Sql:ConnectionStrings:BillingDb â†’ kv:sql-connection-billingdb
      â”œâ”€ Sql:ConnectionStrings:InventoryDb â†’ kv:sql-connection-inventorydb
      â”œâ”€ Sql:ConnectionStrings:OrdersDb â†’ kv:sql-connection-ordersdb
      â”œâ”€ Sql:ConnectionStrings:PurchasingDb â†’ kv:sql-connection-purchasingdb
      â””â”€ Sql:ConnectionStrings:SalesDb â†’ kv:sql-connection-salesdb
</code></pre>
<p><strong>File:</strong> <code>core/configuration/app-configuration.bicep</code></p>
<h3 id="4-monitoring--diagnostics">4. Monitoring &amp; Diagnostics</h3>
<h4 id="log-analytics-workspace">Log Analytics Workspace</h4>
<p><strong>Purpose:</strong> Centralized logging for all services</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Log Analytics
â”œâ”€ SKU: PerGB2018
â”œâ”€ Retention: 30 days (default)
â”‚
â””â”€ Collected Logs
   â”œâ”€ Container Apps logs
   â”œâ”€ Application Insights events
   â”œâ”€ SQL Query Store
   â””â”€ Redis metrics
</code></pre>
<h4 id="application-insights">Application Insights</h4>
<p><strong>Purpose:</strong> Application performance monitoring and tracing</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Application Insights
â”œâ”€ Instrumentation Key: Auto-generated
â”œâ”€ Sampling: 100% (all events)
â”‚
â””â”€ Monitored Metrics
   â”œâ”€ Request duration
   â”œâ”€ Exception rate
   â”œâ”€ Dependency calls
   â”œâ”€ Performance counters
   â””â”€ Custom events
</code></pre>
<p><strong>Files:</strong></p>
<ul>
<li><code>MyApp-LogAnalyticsWorkspace/MyApp-LogAnalyticsWorkspace.module.bicep</code></li>
<li><code>MyApp-ApplicationInsights/MyApp-ApplicationInsights.module.bicep</code></li>
</ul>
<hr>
<h2 id="security-architecture">Security Architecture</h2>
<h3 id="identity--access-management">Identity &amp; Access Management</h3>
<h4 id="managed-identities">Managed Identities</h4>
<pre><code class="lang-mermaid">graph LR
    subgraph &quot;Azure Services&quot;
        AUTH_MI[&quot;Auth Service MI&quot;]
        BILLING_MI[&quot;Billing Service MI&quot;]
        INVENTORY_MI[&quot;Inventory Service MI&quot;]
        ORDERS_MI[&quot;Orders Service MI&quot;]
        PURCHASING_MI[&quot;Purchasing Service MI&quot;]
        SALES_MI[&quot;Sales Service MI&quot;]
        GATEWAY_MI[&quot;API Gateway MI&quot;]
        APPCONFIG_MI[&quot;App Config MI&quot;]
    end
    
    subgraph &quot;Azure Resources&quot;
        APPCONFIG[&quot;App Configuration&quot;]
        KEYVAULT[&quot;Key Vault&quot;]
        ACR[&quot;Container Registry&quot;]
    end
    
    AUTH_MI --&gt;|RBAC| APPCONFIG
    BILLING_MI --&gt;|RBAC| APPCONFIG
    INVENTORY_MI --&gt;|RBAC| APPCONFIG
    ORDERS_MI --&gt;|RBAC| APPCONFIG
    PURCHASING_MI --&gt;|RBAC| APPCONFIG
    SALES_MI --&gt;|RBAC| APPCONFIG
    GATEWAY_MI --&gt;|RBAC| APPCONFIG
    
    APPCONFIG_MI --&gt;|RBAC| KEYVAULT
    
    AUTH_MI --&gt;|RBAC| ACR
    BILLING_MI --&gt;|RBAC| ACR
    INVENTORY_MI --&gt;|RBAC| ACR
    ORDERS_MI --&gt;|RBAC| ACR
    PURCHASING_MI --&gt;|RBAC| ACR
    SALES_MI --&gt;|RBAC| ACR
    GATEWAY_MI --&gt;|RBAC| ACR
    
    style AUTH_MI fill:#87CEEB
    style BILLING_MI fill:#87CEEB
    style INVENTORY_MI fill:#87CEEB
    style ORDERS_MI fill:#87CEEB
    style PURCHASING_MI fill:#87CEEB
    style SALES_MI fill:#87CEEB
    style GATEWAY_MI fill:#FFB6C1
    style APPCONFIG_MI fill:#FFA500
    style APPCONFIG fill:#FFA500
    style KEYVAULT fill:#FF6347
    style ACR fill:#9370DB
</code></pre>
<h4 id="rbac-roles--permissions">RBAC Roles &amp; Permissions</h4>
<table>
<thead>
<tr>
<th>Principal</th>
<th>Role</th>
<th>Target</th>
<th>Permissions</th>
</tr>
</thead>
<tbody>
<tr>
<td>Auth Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Billing Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Inventory Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Orders Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Purchasing Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Sales Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>API Gateway MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>App Config MI</td>
<td>Key Vault Secrets User</td>
<td>Key Vault</td>
<td>Read secrets only</td>
</tr>
<tr>
<td>All Service MIs</td>
<td>AcrPull</td>
<td>Container Registry</td>
<td>Pull images</td>
</tr>
</tbody>
</table>
<p><strong>Files:</strong></p>
<ul>
<li><code>core/configuration/appconfig-rbac.bicep</code></li>
<li><code>core/security/keyvault-rbac.bicep</code></li>
<li><code>services/container-app-service.bicep</code> (ACR role assignment)</li>
</ul>
<h3 id="secret-management-flow">Secret Management Flow</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    participant Service as Auth Service&lt;br/&gt;(MI: auth-service-mi)
    participant AppConfig as App Configuration&lt;br/&gt;(MI: appconfig-mi)
    participant KeyVault as Azure Key Vault
    participant SQL as SQL Server&lt;br/&gt;AuthDB
    
    Service-&gt;&gt;AppConfig: 1. Request config key&lt;br/&gt;(Jwt:SecretKey)
    activate AppConfig
    
    AppConfig-&gt;&gt;AppConfig: 2. Check local cache
    
    alt Cache Miss
        AppConfig-&gt;&gt;KeyVault: 3. Resolve KV reference&lt;br/&gt;using appconfig-mi
        activate KeyVault
        KeyVault--&gt;&gt;AppConfig: 4. Return jwt-secret-key
        deactivate KeyVault
        AppConfig-&gt;&gt;AppConfig: 5. Cache locally
    end
    
    AppConfig--&gt;&gt;Service: 6. Return secret value
    deactivate AppConfig
    
    Service-&gt;&gt;Service: 7. Use JWT secret to&lt;br/&gt;sign/verify tokens
    
    Service-&gt;&gt;SQL: 8. Query with token
    activate SQL
    SQL--&gt;&gt;Service: 9. Return data
    deactivate SQL
</code></pre>
<h3 id="zero-trust-security-principles-applied">Zero Trust Security Principles Applied</h3>
<p>âœ… <strong>Identity Verification</strong></p>
<ul>
<li>Managed Identities (no passwords)</li>
<li>Multi-layer authentication</li>
</ul>
<p>âœ… <strong>Least Privilege Access</strong></p>
<ul>
<li>Services only access App Configuration (not Key Vault)</li>
<li>App Configuration only accesses specific secrets</li>
<li>Database access limited by role (TBD Phase 4)</li>
</ul>
<p>âœ… <strong>Encryption</strong></p>
<ul>
<li>TLS 1.2+ for all communications</li>
<li>Secrets encrypted in Key Vault</li>
<li>At-rest encryption on all storage</li>
</ul>
<p>âœ… <strong>Monitoring &amp; Auditing</strong></p>
<ul>
<li>All access logged in Log Analytics</li>
<li>Key Vault access logged with timestamps</li>
<li>Service-to-service calls traced</li>
</ul>
<hr>
<h2 id="data-flow">Data Flow</h2>
<h3 id="request-flow-through-api-gateway">Request Flow Through API Gateway</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    participant Client as External Client
    participant APIGW as API Gateway&lt;br/&gt;(Ocelot)
    participant Auth as Auth Service
    participant BLL as Billing Service
    participant APPCONFIG as App Configuration
    participant CACHE as Redis Cache
    participant DB as SQL Server
    
    Client-&gt;&gt;APIGW: 1. HTTP Request&lt;br/&gt;(POST /orders)
    activate APIGW
    
    APIGW-&gt;&gt;APPCONFIG: 2. Load routing config
    activate APPCONFIG
    APPCONFIG--&gt;&gt;APIGW: 3. Return routes
    deactivate APPCONFIG
    
    APIGW-&gt;&gt;Auth: 4. Forward request to Auth&lt;br/&gt;for JWT validation
    activate Auth
    Auth-&gt;&gt;APPCONFIG: 5. Get Jwt:SecretKey
    APPCONFIG--&gt;&gt;Auth: 6. Return secret (via KV)
    Auth-&gt;&gt;Auth: 7. Validate JWT
    Auth--&gt;&gt;APIGW: 8. Token valid âœ“
    deactivate Auth
    
    APIGW-&gt;&gt;BLL: 9. Route to Billing Service
    activate BLL
    
    BLL-&gt;&gt;CACHE: 10. Check cache key&lt;br/&gt;(billing:invoice:{id})
    activate CACHE
    alt Cache HIT
        CACHE--&gt;&gt;BLL: 11. Return cached data
    else Cache MISS
        deactivate CACHE
        BLL-&gt;&gt;DB: 12. Query database
        activate DB
        DB--&gt;&gt;BLL: 13. Return data
        deactivate DB
        BLL-&gt;&gt;CACHE: 14. Store in cache&lt;br/&gt;(TTL: 5 min)
        activate CACHE
        CACHE--&gt;&gt;BLL: 15. OK
        deactivate CACHE
    end
    
    BLL--&gt;&gt;APIGW: 16. Response data
    deactivate BLL
    
    APIGW--&gt;&gt;Client: 17. HTTP Response&lt;br/&gt;(200 OK + data)
    deactivate APIGW
</code></pre>
<h3 id="service-to-service-communication">Service-to-Service Communication</h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     All Services Inside                      â”‚
â”‚              Azure Container Apps Environment                â”‚
â”‚                   (Private Network)                           â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   Auth      â”‚    â”‚  Billing    â”‚    â”‚ Inventory   â”‚   â”‚
â”‚   â”‚  Service    â”‚â”€â”€â”€â†’â”‚  Service    â”‚â”€â”€â”€â†’â”‚  Service    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â†“                   â†“                    â†“           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   Orders    â”‚    â”‚ Purchasing  â”‚    â”‚  Sales      â”‚   â”‚
â”‚   â”‚  Service    â”‚    â”‚  Service    â”‚    â”‚  Service    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â†“                   â†“                    â†“           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              All services communicate via HTTP/2             â”‚
â”‚            with Managed Identity authentication              â”‚
â”‚              (Dapr service-to-service calls)                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p><strong>Communication Pattern:</strong></p>
<pre><code>Service A â†’ Service B

1. Service A gets own MI token (implicit)
2. Service A calls Service B at https://service-b
3. Service B validates caller's MI
4. Communication established (mTLS)
5. Response returned
</code></pre>
<hr>
<h2 id="deployment-topology">Deployment Topology</h2>
<h3 id="resource-group-organization">Resource Group Organization</h3>
<pre><code>rg-{environment}
â”œâ”€ core/
â”‚  â”œâ”€ Container Apps Environment
â”‚  â”œâ”€ Container Registry
â”‚  â”œâ”€ Log Analytics Workspace
â”‚  â””â”€ Storage Account (file shares)
â”‚
â”œâ”€ database/
â”‚  â”œâ”€ SQL Server
â”‚  â”‚  â”œâ”€ AuthDB
â”‚  â”‚  â”œâ”€ BillingDB
â”‚  â”‚  â”œâ”€ InventoryDB
â”‚  â”‚  â”œâ”€ OrdersDB
â”‚  â”‚  â”œâ”€ PurchasingDB
â”‚  â”‚  â””â”€ SalesDB
â”‚  â””â”€ Redis Cache
â”‚
â”œâ”€ security/
â”‚  â”œâ”€ Key Vault
â”‚  â””â”€ Managed Identities (7 + 1)
â”‚
â”œâ”€ configuration/
â”‚  â”œâ”€ App Configuration
â”‚  â””â”€ Application Insights
â”‚
â””â”€ services/
   â”œâ”€ API Gateway (Container App)
   â”œâ”€ Auth Service (Container App)
   â”œâ”€ Billing Service (Container App)
   â”œâ”€ Inventory Service (Container App)
   â”œâ”€ Orders Service (Container App)
   â”œâ”€ Purchasing Service (Container App)
   â””â”€ Sales Service (Container App)
</code></pre>
<h3 id="bicep-module-hierarchy">Bicep Module Hierarchy</h3>
<pre><code>main.bicep (Orchestrator)
â”œâ”€ resources.bicep (shared resources)
â”œâ”€ core/
â”‚  â”œâ”€ host/container-app.bicep
â”‚  â”œâ”€ database/
â”‚  â”‚  â”œâ”€ redis.bicep
â”‚  â”‚  â””â”€ sql-server.bicep
â”‚  â”œâ”€ security/
â”‚  â”‚  â”œâ”€ keyvault-secrets.bicep
â”‚  â”‚  â””â”€ keyvault-rbac.bicep
â”‚  â””â”€ configuration/
â”‚     â”œâ”€ app-configuration.bicep
â”‚     â””â”€ appconfig-rbac.bicep
â”œâ”€ services/ (1 per microservice)
â”‚  â”œâ”€ auth-service.bicep
â”‚  â”œâ”€ billing-service.bicep
â”‚  â”œâ”€ inventory-service.bicep
â”‚  â”œâ”€ orders-service.bicep
â”‚  â”œâ”€ purchasing-service.bicep
â”‚  â”œâ”€ sales-service.bicep
â”‚  â”œâ”€ api-gateway.bicep
â”‚  â””â”€ container-app-service.bicep (shared template)
â””â”€ Infrastructure-as-Code modules
   â”œâ”€ myapp-sqlserver/
   â”œâ”€ myapp-sqlserver-roles/
   â”œâ”€ MyApp-ApplicationInsights/
   â””â”€ MyApp-LogAnalyticsWorkspace/
</code></pre>
<hr>
<h2 id="service-communication">Service Communication</h2>
<h3 id="intra-service-communication-pattern">Intra-Service Communication Pattern</h3>
<pre><code class="lang-mermaid">graph LR
    subgraph &quot;Caller&quot;
        A[&quot;Service A&lt;br/&gt;Managed Identity&quot;]
    end
    
    subgraph &quot;Azure&quot;
        DAPR[&quot;Dapr Sidecar&lt;br/&gt;(Service Invocation)&quot;]
        MTLS[&quot;mTLS Connection&quot;]
    end
    
    subgraph &quot;Callee&quot;
        B[&quot;Service B&lt;br/&gt;Managed Identity&quot;]
    end
    
    A --&gt;|1. Invoke&lt;br/&gt;http://service-b| DAPR
    DAPR --&gt;|2. Check MI&lt;br/&gt;credential| DAPR
    DAPR --&gt;|3. Establish&lt;br/&gt;mTLS| MTLS
    MTLS --&gt;|4. Forward&lt;br/&gt;request| B
    B --&gt;|5. Process&lt;br/&gt;request| B
    B --&gt;|6. Return&lt;br/&gt;response| MTLS
    MTLS --&gt;|7. Forward&lt;br/&gt;response| DAPR
    DAPR --&gt;|8. Return&lt;br/&gt;to caller| A
    
    style A fill:#87CEEB
    style B fill:#87CEEB
    style DAPR fill:#90EE90
    style MTLS fill:#FFD700
</code></pre>
<h3 id="external-communication-pattern">External Communication Pattern</h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Internet (Public)                         â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Client (Web/Mobile)                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ HTTPS TLS 1.2+                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Certificate validation                   â”‚  â”‚
â”‚  â”‚  â””â”€ Header: Authorization: Bearer {JWT}      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Azure Container Apps                      â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Gateway (External Ingress Enabled)      â”‚  â”‚
â”‚  â”‚  â”œâ”€ Ocelot (API Gateway middleware)          â”‚  â”‚
â”‚  â”‚  â”œâ”€ HTTPS only                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ Rate limiting                            â”‚  â”‚
â”‚  â”‚  â””â”€ JWT validation                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Internal Services (Private Network)         â”‚  â”‚
â”‚  â”‚  â”œâ”€ Auth Service                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ Billing Service                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Inventory Service                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Orders Service                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ Purchasing Service                       â”‚  â”‚
â”‚  â”‚  â””â”€ Sales Service                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Azure Data Services                       â”‚
â”‚                                                     â”‚
â”‚  â”œâ”€ SQL Server (Private endpoint)                  â”‚
â”‚  â”œâ”€ Redis Cache (Private endpoint)                â”‚
â”‚  â”œâ”€ Key Vault (Firewall rules)                    â”‚
â”‚  â””â”€ App Configuration (Firewall rules)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<hr>
<h2 id="scaling--performance">Scaling &amp; Performance</h2>
<h3 id="auto-scaling-configuration">Auto-Scaling Configuration</h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Service Auto-Scaling Rules           â”‚
â”‚                                             â”‚
â”‚  Each Container App:                        â”‚
â”‚  â”œâ”€ Min Replicas: 1                        â”‚
â”‚  â”œâ”€ Max Replicas: 10                       â”‚
â”‚  â”œâ”€ CPU per instance: 0.5 cores            â”‚
â”‚  â”œâ”€ Memory per instance: 1 GB              â”‚
â”‚  â”‚                                         â”‚
â”‚  â””â”€ Scaling Rules:                         â”‚
â”‚     â”œâ”€ HTTP Requests: Scale on 70% CPU    â”‚
â”‚     â”œâ”€ Concurrency: Scale on connections  â”‚
â”‚     â””â”€ Queue Length: Scale on queue depth â”‚
â”‚                                             â”‚
â”‚  Scaling Behavior:                         â”‚
â”‚  â”œâ”€ Scale-up: +2 replicas (60 seconds)    â”‚
â”‚  â”œâ”€ Scale-down: -1 replica (300 seconds)  â”‚
â”‚  â””â”€ Max scale rate: +100% replicas/min    â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="performance-optimization">Performance Optimization</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Optimization</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Redis Cache</strong></td>
<td>- allkeys-lru eviction policy<br>- 5-minute TTL for query results<br>- Connection pooling</td>
</tr>
<tr>
<td><strong>SQL Server</strong></td>
<td>- Query Store enabled<br>- Automatic statistics<br>- TempDB optimization<br>- Index maintenance</td>
</tr>
<tr>
<td><strong>App Config</strong></td>
<td>- 30-second cache in clients<br>- Key Vault reference caching<br>- Batch key reads</td>
</tr>
<tr>
<td><strong>Services</strong></td>
<td>- Connection pooling to DB<br>- Redis distributed caching<br>- Async/await patterns<br>- Dapr pub/sub for events</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="disaster-recovery">Disaster Recovery</h2>
<h3 id="backup-strategy">Backup Strategy</h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Backup Strategy                      â”‚
â”‚                                                 â”‚
â”‚  Database Backups (SQL Server)                  â”‚
â”‚  â”œâ”€ Full Backup: Daily (automatic)              â”‚
â”‚  â”œâ”€ Differential: Every 4 hours                 â”‚
â”‚  â”œâ”€ Transaction Log: Every 15 minutes           â”‚
â”‚  â”œâ”€ Retention: 35 days                          â”‚
â”‚  â””â”€ Recovery: RPO &lt; 15 min, RTO &lt; 1 hour       â”‚
â”‚                                                 â”‚
â”‚  Configuration Backups                          â”‚
â”‚  â”œâ”€ App Configuration: Version control (Git)    â”‚
â”‚  â”œâ”€ Bicep templates: Git repository             â”‚
â”‚  â”œâ”€ Key Vault: Enabled for recovery             â”‚
â”‚  â””â”€ Secrets: Not backed up (regenerate)         â”‚
â”‚                                                 â”‚
â”‚  Container Images                               â”‚
â”‚  â”œâ”€ ACR: Geo-replication ready                  â”‚
â”‚  â”œâ”€ Retention: Latest 10 versions               â”‚
â”‚  â””â”€ Scan: Continuous vulnerability scan         â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="failover--recovery">Failover &amp; Recovery</h3>
<pre><code class="lang-mermaid">graph TD
    A[&quot;Failure Detected&lt;br/&gt;(Health check)&quot;] --&gt; B[&quot;Auto-scale triggered&quot;]
    B --&gt; C{&quot;Failure Type?&quot;}
    
    C --&gt;|Pod Crash| D[&quot;Orchestrator spins&lt;br/&gt;new replica&quot;]
    D --&gt; E[&quot;Service restored&lt;br/&gt;on new instance&quot;]
    
    C --&gt;|Zone Failure| F[&quot;Load balanced to&lt;br/&gt;other zones&quot;]
    F --&gt; E
    
    C --&gt;|Service Degradation| G[&quot;Alert sent to&lt;br/&gt;Operations&quot;]
    G --&gt; H[&quot;Manual intervention&lt;br/&gt;if needed&quot;]
    
    C --&gt;|Data Corruption| I[&quot;Restore from&lt;br/&gt;backup&quot;]
    I --&gt; J[&quot;Point-in-time&lt;br/&gt;recovery&quot;]
    J --&gt; K[&quot;Services resume&quot;]
    
    E --&gt; L[&quot;Health check passes&quot;]
    K --&gt; L
    L --&gt; M[&quot;Traffic restored&quot;]
</code></pre>
<hr>
<h2 id="implementation-details">Implementation Details</h2>
<h3 id="bicep-parameter-inputs">Bicep Parameter Inputs</h3>
<pre><code class="lang-bicep">// Required Parameters
param environmentName string              // e.g., &quot;prod&quot;
param location string                     // e.g., &quot;eastus&quot;

// Secure Parameters (generated)
@secure() param cache_password string     // Redis authentication
@secure() param password string           // SQL admin password
@secure() param jwtSecretKey string       // JWT signing key

// Configuration Parameters
param jwtIssuer string                    // JWT token issuer
param jwtAudience string                  // JWT token audience
param frontendOrigin string                // CORS origins
param aspnetcoreEnvironment string        // Dev/Staging/Prod
</code></pre>
<h3 id="container-app-configuration">Container App Configuration</h3>
<pre><code class="lang-bicep">CPU:              0.5 cores
Memory:           1 GB
Replicas:         Min: 1, Max: 10
Environment:      Container Apps Environment
Ingress:          Enabled/Disabled per service
External:         Enabled only for API Gateway
Dapr:             Enabled for service-to-service
Service Invocation: Enabled (mTLS)
State Management: Redis-backed
</code></pre>
<h3 id="environment-variables-per-service">Environment Variables Per Service</h3>
<pre><code class="lang-bicep">Common to All:
â”œâ”€ ASPNETCORE_ENVIRONMENT
â”œâ”€ ApplicationInsights__InstrumentationKey
â”œâ”€ Logging__LogLevel__Default
â””â”€ OpenTelemetry__Enabled

Service-Specific:
â”œâ”€ Database connection (from App Config)
â”œâ”€ Cache connection (from App Config)
â”œâ”€ JWT configuration (from App Config)
â”œâ”€ Service-specific settings
â””â”€ Feature flags (from App Config)
</code></pre>
<hr>
<h2 id="security-best-practices-implemented">Security Best Practices Implemented</h2>
<h3 id="-authentication--authorization">âœ… Authentication &amp; Authorization</h3>
<ul>
<li>[x] Managed Identities (no passwords)</li>
<li>[x] Azure RBAC for resource access</li>
<li>[x] JWT tokens for service-to-service calls</li>
<li>[x] TLS 1.2+ enforcement</li>
<li>[x] mTLS between services (Dapr)</li>
</ul>
<h3 id="-secret-management">âœ… Secret Management</h3>
<ul>
<li>[x] Azure Key Vault for all secrets</li>
<li>[x] No secrets in code or config files</li>
<li>[x] Centralized access via App Configuration</li>
<li>[x] Secrets never logged</li>
<li>[x] Audit logging for all access</li>
</ul>
<h3 id="-network-security">âœ… Network Security</h3>
<ul>
<li>[x] Firewall rules on Key Vault</li>
<li>[x] Private endpoints (optional)</li>
<li>[x] Network policies (NSGs)</li>
<li>[x] DDoS protection (standard)</li>
<li>[x] Service-to-service mTLS</li>
</ul>
<h3 id="-data-protection">âœ… Data Protection</h3>
<ul>
<li>[x] Encryption in transit (TLS)</li>
<li>[x] Encryption at rest (managed keys)</li>
<li>[x] Database encryption (TDE)</li>
<li>[x] Redis encryption (optional)</li>
<li>[x] Key rotation (manual)</li>
</ul>
<h3 id="-monitoring--auditing">âœ… Monitoring &amp; Auditing</h3>
<ul>
<li>[x] All resource access logged</li>
<li>[x] Key Vault access audit trail</li>
<li>[x] Service logs to Log Analytics</li>
<li>[x] Application Insights tracing</li>
<li>[x] Alerts for suspicious activity</li>
</ul>
<hr>
<h2 id="deployment-process">Deployment Process</h2>
<h3 id="prerequisites">Prerequisites</h3>
<pre><code class="lang-powershell"># Azure CLI
az --version  # 2.50+

# Bicep
az bicep version

# PowerShell
$PSVersionTable.PSVersion  # 5.1+

# Authenticated to Azure
az account show
</code></pre>
<h3 id="deployment-steps">Deployment Steps</h3>
<pre><code class="lang-powershell"># 1. Generate secure parameters
$jwtSecret = [Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(48))
$cachePassword = [Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))
$sqlPassword = &quot;P@ssw0rd!Complex&quot; # 8-128 chars, special chars required

# 2. Create parameters file
$params = @{
    environmentName = &quot;prod&quot;
    location = &quot;eastus&quot;
    jwtSecretKey = $jwtSecret
    cache_password = $cachePassword
    password = $sqlPassword
}

# 3. Validate Bicep
az bicep build --file main.bicep

# 4. Validate deployment
az deployment sub validate `
  --template-file main.bicep `
  --parameters $params `
  --location eastus

# 5. Deploy infrastructure
az deployment sub create `
  --template-file main.bicep `
  --parameters $params `
  --name &quot;erp-deployment-$(Get-Date -Format 'yyyyMMdd-HHmmss')&quot; `
  --location eastus
</code></pre>
<hr>
<h2 id="appendix-quick-reference">Appendix: Quick Reference</h2>
<h3 id="important-urls">Important URLs</h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>URL Pattern</th>
<th>Access</th>
</tr>
</thead>
<tbody>
<tr>
<td>API Gateway</td>
<td><code>https://{fqdn}.${location}.azurecontainerapps.io</code></td>
<td>External</td>
</tr>
<tr>
<td>Auth Service</td>
<td><code>https://auth-service.${domain}</code></td>
<td>Internal</td>
</tr>
<tr>
<td>App Insights</td>
<td><code>https://portal.azure.com</code></td>
<td>Azure Portal</td>
</tr>
<tr>
<td>Key Vault</td>
<td><code>https://{vault-name}.vault.azure.net</code></td>
<td>Azure Portal</td>
</tr>
<tr>
<td>App Config</td>
<td><code>https://{store-name}.azconfig.io</code></td>
<td>Azure Portal</td>
</tr>
</tbody>
</table>
<h3 id="useful-azure-cli-commands">Useful Azure CLI Commands</h3>
<pre><code class="lang-powershell"># List all services
az containerapp list -g rg-{environment} -o table

# View logs
az containerapp logs show -g rg-{environment} -n {service-name}

# Scale manually
az containerapp update -g rg-{environment} -n {service-name} `
  --min-replicas 2 --max-replicas 20

# Get secrets from Key Vault
az keyvault secret show --vault-name {vault-name} --name {secret-name}

# View configuration
az appconfig kv list --name {config-store-name}
</code></pre>
<h3 id="monitoring-queries-kql">Monitoring Queries (KQL)</h3>
<pre><code class="lang-kusto">// Service errors (last 24h)
traces
| where severity == &quot;Error&quot;
| where timestamp &gt; ago(24h)
| summarize Count = count() by name

// API response times
customMetrics
| where name == &quot;RequestDuration&quot;
| summarize AvgDuration = avg(value) by bin(timestamp, 5m)

// Service dependencies
dependencies
| summarize by type, name
| sort by name
</code></pre>
<hr>
<p><strong>Document Version:</strong> 1.0<br>
<strong>Last Updated:</strong> 2024-10-27<br>
<strong>Status:</strong> âœ… Complete - Production Ready</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/architecture/ARCHITECTURE_DOCUMENTATION.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          ERP Microservices - A cloud-native ERP system built with .NET 9
        </div>
      </div>
    </footer>
  </body>
</html>
