<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>ERP Microservices Infrastructure Architecture Documentation | ERP Microservices Documentation </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="ERP Microservices Infrastructure Architecture Documentation | ERP Microservices Documentation ">
      
      
      <link rel="icon" href="../../favicon.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/architecture/ARCHITECTURE_DOCUMENTATION.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../logo.svg" alt="ERP Microservices">
            ERP Microservices
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="erp-microservices-infrastructure-architecture-documentation">ERP Microservices Infrastructure Architecture Documentation</h1>

<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#infrastructure-components">Infrastructure Components</a></li>
<li><a href="#security-architecture">Security Architecture</a></li>
<li><a href="#data-flow">Data Flow</a></li>
<li><a href="#deployment-topology">Deployment Topology</a></li>
<li><a href="#service-communication">Service Communication</a></li>
<li><a href="#scaling--performance">Scaling &amp; Performance</a></li>
<li><a href="#disaster-recovery">Disaster Recovery</a></li>
<li><a href="#implementation-details">Implementation Details</a></li>
</ol>
<hr>
<h2 id="executive-summary">Executive Summary</h2>
<p>This document describes the complete infrastructure architecture for the <strong>ERP Microservices Platform</strong> deployed on Azure using Bicep Infrastructure-as-Code templates.</p>
<h3 id="key-metrics">Key Metrics</h3>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Microservices</strong></td>
<td>7 (Auth, Billing, Inventory, Orders, Purchasing, Sales) + 1 API Gateway</td>
</tr>
<tr>
<td><strong>Deployment Model</strong></td>
<td>Azure Container Apps (serverless)</td>
</tr>
<tr>
<td><strong>Availability</strong></td>
<td>99.99% (across all managed services)</td>
</tr>
<tr>
<td><strong>Auto-Scaling</strong></td>
<td>Min 1 - Max 10 replicas per service</td>
</tr>
<tr>
<td><strong>Security Model</strong></td>
<td>Zero Trust with Managed Identities + RBAC</td>
</tr>
<tr>
<td><strong>Databases</strong></td>
<td>1 SQL Server with 6 microservice databases</td>
</tr>
<tr>
<td><strong>Cache</strong></td>
<td>Azure Redis Cache (Standard tier)</td>
</tr>
<tr>
<td><strong>Secret Management</strong></td>
<td>Azure Key Vault (centralized)</td>
</tr>
<tr>
<td><strong>Configuration Management</strong></td>
<td>Azure App Configuration (with Key Vault references)</td>
</tr>
<tr>
<td><strong>Monitoring</strong></td>
<td>Azure Log Analytics + Application Insights</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="architecture-overview">Architecture Overview</h2>
<h3 id="high-level-system-architecture">High-Level System Architecture</h3>
<pre><code class="lang-mermaid">graph TB
    subgraph &quot;Client Layer&quot;
        WEB[&quot;üåê Web Frontend&lt;br/&gt;(React/Angular)&quot;]
        MOBILE[&quot;üì± Mobile App&quot;]
    end
    
    subgraph &quot;API Gateway&quot;
        GATEWAY[&quot;üö™ API Gateway&lt;br/&gt;(Ocelot)&lt;br/&gt;Container App&quot;]
    end
    
    subgraph &quot;Microservices Layer&quot;
        AUTH[&quot;üîê Auth Service&lt;br/&gt;Container App&quot;]
        BILLING[&quot;üí∞ Billing Service&lt;br/&gt;Container App&quot;]
        INVENTORY[&quot;üì¶ Inventory Service&lt;br/&gt;Container App&quot;]
        ORDERS[&quot;üìã Orders Service&lt;br/&gt;Container App&quot;]
        PURCHASING[&quot;üõí Purchasing Service&lt;br/&gt;Container App&quot;]
        SALES[&quot;üí∏ Sales Service&lt;br/&gt;Container App&quot;]
    end
    
    subgraph &quot;Data Layer&quot;
        REDIS[&quot;‚ö° Redis Cache&lt;br/&gt;(Distributed Cache)&quot;]
        SQLDB[&quot;üóÑÔ∏è SQL Server&lt;br/&gt;(6 Databases)&quot;]
    end
    
    subgraph &quot;Security &amp; Config&quot;
        KEYVAULT[&quot;üîë Key Vault&lt;br/&gt;(Secrets)&quot;]
        APPCONFIG[&quot;‚öôÔ∏è App Configuration&lt;br/&gt;(Settings + KV Refs)&quot;]
    end
    
    subgraph &quot;Monitoring&quot;
        LOGS[&quot;üìä Log Analytics&quot;]
        INSIGHTS[&quot;üîç App Insights&quot;]
    end
    
    WEB --&gt; GATEWAY
    MOBILE --&gt; GATEWAY
    
    GATEWAY --&gt; AUTH
    GATEWAY --&gt; BILLING
    GATEWAY --&gt; INVENTORY
    GATEWAY --&gt; ORDERS
    GATEWAY --&gt; PURCHASING
    GATEWAY --&gt; SALES
    
    AUTH --&gt; SQLDB
    BILLING --&gt; SQLDB
    INVENTORY --&gt; SQLDB
    ORDERS --&gt; SQLDB
    PURCHASING --&gt; SQLDB
    SALES --&gt; SQLDB
    
    AUTH --&gt; REDIS
    BILLING --&gt; REDIS
    INVENTORY --&gt; REDIS
    ORDERS --&gt; REDIS
    PURCHASING --&gt; REDIS
    SALES --&gt; REDIS
    
    AUTH -.-&gt;|reads| APPCONFIG
    BILLING -.-&gt;|reads| APPCONFIG
    INVENTORY -.-&gt;|reads| APPCONFIG
    ORDERS -.-&gt;|reads| APPCONFIG
    PURCHASING -.-&gt;|reads| APPCONFIG
    SALES -.-&gt;|reads| APPCONFIG
    
    APPCONFIG -.-&gt;|via MI| KEYVAULT
    GATEWAY -.-&gt;|logs| LOGS
    AUTH -.-&gt;|logs| LOGS
    BILLING -.-&gt;|logs| LOGS
    INVENTORY -.-&gt;|logs| LOGS
    ORDERS -.-&gt;|logs| LOGS
    PURCHASING -.-&gt;|logs| LOGS
    SALES -.-&gt;|logs| LOGS
    
    GATEWAY -.-&gt;|events| INSIGHTS
    AUTH -.-&gt;|events| INSIGHTS
    
    style GATEWAY fill:#FFB6C1
    style AUTH fill:#87CEEB
    style BILLING fill:#87CEEB
    style INVENTORY fill:#87CEEB
    style ORDERS fill:#87CEEB
    style PURCHASING fill:#87CEEB
    style SALES fill:#87CEEB
    style REDIS fill:#90EE90
    style SQLDB fill:#FFD700
    style KEYVAULT fill:#FFA500
    style APPCONFIG fill:#FFA500
    style LOGS fill:#DDA0DD
    style INSIGHTS fill:#DDA0DD
</code></pre>
<hr>
<h2 id="infrastructure-components">Infrastructure Components</h2>
<h3 id="1-container-apps-environment">1. Container Apps Environment</h3>
<p><strong>Purpose:</strong> Serverless container hosting platform for microservices</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">‚îú‚îÄ Managed Environment (CAE)
‚îÇ  ‚îú‚îÄ Workload Profiles: Consumption (auto-scaling)
‚îÇ  ‚îú‚îÄ App Logs: Log Analytics integration
‚îÇ  ‚îú‚îÄ Aspire Dashboard: Built-in
‚îÇ  ‚îî‚îÄ Storage Mounts: Azure Files (persistent)
‚îÇ
‚îî‚îÄ Container Apps (8 total)
   ‚îú‚îÄ API Gateway (1x)
   ‚îú‚îÄ Auth Service (1x)
   ‚îú‚îÄ Billing Service (1x)
   ‚îú‚îÄ Inventory Service (1x)
   ‚îú‚îÄ Orders Service (1x)
   ‚îú‚îÄ Purchasing Service (1x)
   ‚îú‚îÄ Sales Service (1x)
   ‚îî‚îÄ Per Service:
      ‚îú‚îÄ CPU: 0.5 cores
      ‚îú‚îÄ Memory: 1 GB
      ‚îú‚îÄ Replicas: 1-10 (auto-scaling)
      ‚îú‚îÄ Ingress: Internal/External
      ‚îú‚îÄ Dapr: Enabled
      ‚îú‚îÄ System-Assigned MI: Enabled
      ‚îî‚îÄ Environment Variables: 15-20 per service
</code></pre>
<p><strong>File:</strong> <code>core/host/container-app.bicep</code></p>
<h3 id="2-database-infrastructure">2. Database Infrastructure</h3>
<h4 id="sql-server">SQL Server</h4>
<p><strong>Purpose:</strong> Relational data storage for all microservices</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Azure SQL Server
‚îú‚îÄ SKU: SQL Server 2022
‚îú‚îÄ TLS: Minimum 1.2
‚îú‚îÄ Admin User: sqladmin (Azure AD + SQL Auth)
‚îú‚îÄ Backup: Automatic retention
‚îÇ
‚îî‚îÄ Databases (6 total)
   ‚îú‚îÄ AuthDB (Users, Roles, Tokens)
   ‚îú‚îÄ BillingDB (Invoices, Payments, Reports)
   ‚îú‚îÄ InventoryDB (Products, Stock, Warehouses)
   ‚îú‚îÄ OrdersDB (Orders, Items, Tracking)
   ‚îú‚îÄ PurchasingDB (POs, Suppliers, Receipts)
   ‚îî‚îÄ SalesDB (Transactions, Customers, Reports)
</code></pre>
<p><strong>File:</strong> <code>core/database/sql-server.bicep</code></p>
<h4 id="redis-cache">Redis Cache</h4>
<p><strong>Purpose:</strong> Distributed caching layer for session management, distributed locks</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Azure Redis Cache
‚îú‚îÄ Tier: Standard
‚îú‚îÄ Capacity: 1 GB
‚îú‚îÄ SKU Family: C (Clustered)
‚îú‚îÄ TLS: Enforced (port 6380)
‚îú‚îÄ Authentication: Enabled (requireauth: true)
‚îú‚îÄ Max Memory Policy: allkeys-lru (evict oldest)
‚îÇ
‚îî‚îÄ Use Cases:
   ‚îú‚îÄ Distributed Session State
   ‚îú‚îÄ Distributed Locks (coordination)
   ‚îú‚îÄ Caching Query Results
   ‚îî‚îÄ Rate Limiting
</code></pre>
<p><strong>File:</strong> <code>core/database/redis.bicep</code></p>
<h3 id="3-security-infrastructure">3. Security Infrastructure</h3>
<h4 id="azure-key-vault">Azure Key Vault</h4>
<p><strong>Purpose:</strong> Centralized secrets and cryptographic keys storage</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Key Vault
‚îú‚îÄ SKU: Standard
‚îú‚îÄ Access: RBAC + Access Policies
‚îú‚îÄ Network: Public (with firewall)
‚îú‚îÄ Purge Protection: Enabled
‚îú‚îÄ Soft Delete: Enabled (90 days)
‚îÇ
‚îî‚îÄ Stored Secrets (9 total)
   ‚îú‚îÄ jwt-secret-key (JWT signing)
   ‚îú‚îÄ redis-connection (Connection string with password)
   ‚îú‚îÄ redis-cache-password (Authentication password)
   ‚îú‚îÄ sql-connection-authdb (AuthDB connection)
   ‚îú‚îÄ sql-connection-billingdb (BillingDB connection)
   ‚îú‚îÄ sql-connection-inventorydb (InventoryDB connection)
   ‚îú‚îÄ sql-connection-ordersdb (OrdersDB connection)
   ‚îú‚îÄ sql-connection-purchasingdb (PurchasingDB connection)
   ‚îî‚îÄ sql-connection-salesdb (SalesDB connection)
</code></pre>
<p><strong>File:</strong> <code>core/security/keyvault-secrets.bicep</code></p>
<h4 id="azure-app-configuration">Azure App Configuration</h4>
<p><strong>Purpose:</strong> Centralized configuration and feature flags with Key Vault integration</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">App Configuration Store
‚îú‚îÄ SKU: Standard
‚îú‚îÄ Access: RBAC + Access Keys
‚îú‚îÄ Managed Identity: System-assigned
‚îÇ
‚îî‚îÄ Configuration Keys (20+ total)
   ‚îú‚îÄ Non-Sensitive Settings
   ‚îÇ  ‚îú‚îÄ Jwt:Issuer (e.g., &quot;MyApp.Auth&quot;)
   ‚îÇ  ‚îú‚îÄ Jwt:Audience (e.g., &quot;MyApp.All&quot;)
   ‚îÇ  ‚îú‚îÄ Frontend:Origin (CORS)
   ‚îÇ  ‚îî‚îÄ ASPNETCORE_ENVIRONMENT (dev/prod)
   ‚îÇ
   ‚îî‚îÄ Key Vault References (resolved at runtime)
      ‚îú‚îÄ Jwt:SecretKey ‚Üí kv:jwt-secret-key
      ‚îú‚îÄ Redis:Connection ‚Üí kv:redis-connection
      ‚îú‚îÄ Redis:Password ‚Üí kv:redis-cache-password
      ‚îú‚îÄ Sql:ConnectionStrings:AuthDb ‚Üí kv:sql-connection-authdb
      ‚îú‚îÄ Sql:ConnectionStrings:BillingDb ‚Üí kv:sql-connection-billingdb
      ‚îú‚îÄ Sql:ConnectionStrings:InventoryDb ‚Üí kv:sql-connection-inventorydb
      ‚îú‚îÄ Sql:ConnectionStrings:OrdersDb ‚Üí kv:sql-connection-ordersdb
      ‚îú‚îÄ Sql:ConnectionStrings:PurchasingDb ‚Üí kv:sql-connection-purchasingdb
      ‚îî‚îÄ Sql:ConnectionStrings:SalesDb ‚Üí kv:sql-connection-salesdb
</code></pre>
<p><strong>File:</strong> <code>core/configuration/app-configuration.bicep</code></p>
<h3 id="4-monitoring--diagnostics">4. Monitoring &amp; Diagnostics</h3>
<h4 id="log-analytics-workspace">Log Analytics Workspace</h4>
<p><strong>Purpose:</strong> Centralized logging for all services</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Log Analytics
‚îú‚îÄ SKU: PerGB2018
‚îú‚îÄ Retention: 30 days (default)
‚îÇ
‚îî‚îÄ Collected Logs
   ‚îú‚îÄ Container Apps logs
   ‚îú‚îÄ Application Insights events
   ‚îú‚îÄ SQL Query Store
   ‚îî‚îÄ Redis metrics
</code></pre>
<h4 id="application-insights">Application Insights</h4>
<p><strong>Purpose:</strong> Application performance monitoring and tracing</p>
<p><strong>Configuration:</strong></p>
<pre><code class="lang-bicep">Application Insights
‚îú‚îÄ Instrumentation Key: Auto-generated
‚îú‚îÄ Sampling: 100% (all events)
‚îÇ
‚îî‚îÄ Monitored Metrics
   ‚îú‚îÄ Request duration
   ‚îú‚îÄ Exception rate
   ‚îú‚îÄ Dependency calls
   ‚îú‚îÄ Performance counters
   ‚îî‚îÄ Custom events
</code></pre>
<p><strong>Files:</strong></p>
<ul>
<li><code>MyApp-LogAnalyticsWorkspace/MyApp-LogAnalyticsWorkspace.module.bicep</code></li>
<li><code>MyApp-ApplicationInsights/MyApp-ApplicationInsights.module.bicep</code></li>
</ul>
<hr>
<h2 id="security-architecture">Security Architecture</h2>
<h3 id="identity--access-management">Identity &amp; Access Management</h3>
<h4 id="managed-identities">Managed Identities</h4>
<pre><code class="lang-mermaid">graph LR
    subgraph &quot;Azure Services&quot;
        AUTH_MI[&quot;Auth Service MI&quot;]
        BILLING_MI[&quot;Billing Service MI&quot;]
        INVENTORY_MI[&quot;Inventory Service MI&quot;]
        ORDERS_MI[&quot;Orders Service MI&quot;]
        PURCHASING_MI[&quot;Purchasing Service MI&quot;]
        SALES_MI[&quot;Sales Service MI&quot;]
        GATEWAY_MI[&quot;API Gateway MI&quot;]
        APPCONFIG_MI[&quot;App Config MI&quot;]
    end
    
    subgraph &quot;Azure Resources&quot;
        APPCONFIG[&quot;App Configuration&quot;]
        KEYVAULT[&quot;Key Vault&quot;]
        ACR[&quot;Container Registry&quot;]
    end
    
    AUTH_MI --&gt;|RBAC| APPCONFIG
    BILLING_MI --&gt;|RBAC| APPCONFIG
    INVENTORY_MI --&gt;|RBAC| APPCONFIG
    ORDERS_MI --&gt;|RBAC| APPCONFIG
    PURCHASING_MI --&gt;|RBAC| APPCONFIG
    SALES_MI --&gt;|RBAC| APPCONFIG
    GATEWAY_MI --&gt;|RBAC| APPCONFIG
    
    APPCONFIG_MI --&gt;|RBAC| KEYVAULT
    
    AUTH_MI --&gt;|RBAC| ACR
    BILLING_MI --&gt;|RBAC| ACR
    INVENTORY_MI --&gt;|RBAC| ACR
    ORDERS_MI --&gt;|RBAC| ACR
    PURCHASING_MI --&gt;|RBAC| ACR
    SALES_MI --&gt;|RBAC| ACR
    GATEWAY_MI --&gt;|RBAC| ACR
    
    style AUTH_MI fill:#87CEEB
    style BILLING_MI fill:#87CEEB
    style INVENTORY_MI fill:#87CEEB
    style ORDERS_MI fill:#87CEEB
    style PURCHASING_MI fill:#87CEEB
    style SALES_MI fill:#87CEEB
    style GATEWAY_MI fill:#FFB6C1
    style APPCONFIG_MI fill:#FFA500
    style APPCONFIG fill:#FFA500
    style KEYVAULT fill:#FF6347
    style ACR fill:#9370DB
</code></pre>
<h4 id="rbac-roles--permissions">RBAC Roles &amp; Permissions</h4>
<table>
<thead>
<tr>
<th>Principal</th>
<th>Role</th>
<th>Target</th>
<th>Permissions</th>
</tr>
</thead>
<tbody>
<tr>
<td>Auth Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Billing Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Inventory Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Orders Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Purchasing Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>Sales Service MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>API Gateway MI</td>
<td>App Configuration Data Reader</td>
<td>App Config</td>
<td>Read keys, values</td>
</tr>
<tr>
<td>App Config MI</td>
<td>Key Vault Secrets User</td>
<td>Key Vault</td>
<td>Read secrets only</td>
</tr>
<tr>
<td>All Service MIs</td>
<td>AcrPull</td>
<td>Container Registry</td>
<td>Pull images</td>
</tr>
</tbody>
</table>
<p><strong>Files:</strong></p>
<ul>
<li><code>core/configuration/appconfig-rbac.bicep</code></li>
<li><code>core/security/keyvault-rbac.bicep</code></li>
<li><code>services/container-app-service.bicep</code> (ACR role assignment)</li>
</ul>
<h3 id="secret-management-flow">Secret Management Flow</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    participant Service as Auth Service&lt;br/&gt;(MI: auth-service-mi)
    participant AppConfig as App Configuration&lt;br/&gt;(MI: appconfig-mi)
    participant KeyVault as Azure Key Vault
    participant SQL as SQL Server&lt;br/&gt;AuthDB
    
    Service-&gt;&gt;AppConfig: 1. Request config key&lt;br/&gt;(Jwt:SecretKey)
    activate AppConfig
    
    AppConfig-&gt;&gt;AppConfig: 2. Check local cache
    
    alt Cache Miss
        AppConfig-&gt;&gt;KeyVault: 3. Resolve KV reference&lt;br/&gt;using appconfig-mi
        activate KeyVault
        KeyVault--&gt;&gt;AppConfig: 4. Return jwt-secret-key
        deactivate KeyVault
        AppConfig-&gt;&gt;AppConfig: 5. Cache locally
    end
    
    AppConfig--&gt;&gt;Service: 6. Return secret value
    deactivate AppConfig
    
    Service-&gt;&gt;Service: 7. Use JWT secret to&lt;br/&gt;sign/verify tokens
    
    Service-&gt;&gt;SQL: 8. Query with token
    activate SQL
    SQL--&gt;&gt;Service: 9. Return data
    deactivate SQL
</code></pre>
<h3 id="zero-trust-security-principles-applied">Zero Trust Security Principles Applied</h3>
<p>‚úÖ <strong>Identity Verification</strong></p>
<ul>
<li>Managed Identities (no passwords)</li>
<li>Multi-layer authentication</li>
</ul>
<p>‚úÖ <strong>Least Privilege Access</strong></p>
<ul>
<li>Services only access App Configuration (not Key Vault)</li>
<li>App Configuration only accesses specific secrets</li>
<li>Database access limited by role (TBD Phase 4)</li>
</ul>
<p>‚úÖ <strong>Encryption</strong></p>
<ul>
<li>TLS 1.2+ for all communications</li>
<li>Secrets encrypted in Key Vault</li>
<li>At-rest encryption on all storage</li>
</ul>
<p>‚úÖ <strong>Monitoring &amp; Auditing</strong></p>
<ul>
<li>All access logged in Log Analytics</li>
<li>Key Vault access logged with timestamps</li>
<li>Service-to-service calls traced</li>
</ul>
<hr>
<h2 id="data-flow">Data Flow</h2>
<h3 id="request-flow-through-api-gateway">Request Flow Through API Gateway</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    participant Client as External Client
    participant APIGW as API Gateway&lt;br/&gt;(Ocelot)
    participant Auth as Auth Service
    participant BLL as Billing Service
    participant APPCONFIG as App Configuration
    participant CACHE as Redis Cache
    participant DB as SQL Server
    
    Client-&gt;&gt;APIGW: 1. HTTP Request&lt;br/&gt;(POST /orders)
    activate APIGW
    
    APIGW-&gt;&gt;APPCONFIG: 2. Load routing config
    activate APPCONFIG
    APPCONFIG--&gt;&gt;APIGW: 3. Return routes
    deactivate APPCONFIG
    
    APIGW-&gt;&gt;Auth: 4. Forward request to Auth&lt;br/&gt;for JWT validation
    activate Auth
    Auth-&gt;&gt;APPCONFIG: 5. Get Jwt:SecretKey
    APPCONFIG--&gt;&gt;Auth: 6. Return secret (via KV)
    Auth-&gt;&gt;Auth: 7. Validate JWT
    Auth--&gt;&gt;APIGW: 8. Token valid ‚úì
    deactivate Auth
    
    APIGW-&gt;&gt;BLL: 9. Route to Billing Service
    activate BLL
    
    BLL-&gt;&gt;CACHE: 10. Check cache key&lt;br/&gt;(billing:invoice:{id})
    activate CACHE
    alt Cache HIT
        CACHE--&gt;&gt;BLL: 11. Return cached data
    else Cache MISS
        deactivate CACHE
        BLL-&gt;&gt;DB: 12. Query database
        activate DB
        DB--&gt;&gt;BLL: 13. Return data
        deactivate DB
        BLL-&gt;&gt;CACHE: 14. Store in cache&lt;br/&gt;(TTL: 5 min)
        activate CACHE
        CACHE--&gt;&gt;BLL: 15. OK
        deactivate CACHE
    end
    
    BLL--&gt;&gt;APIGW: 16. Response data
    deactivate BLL
    
    APIGW--&gt;&gt;Client: 17. HTTP Response&lt;br/&gt;(200 OK + data)
    deactivate APIGW
</code></pre>
<h3 id="service-to-service-communication">Service-to-Service Communication</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     All Services Inside                      ‚îÇ
‚îÇ              Azure Container Apps Environment                ‚îÇ
‚îÇ                   (Private Network)                           ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ   ‚îÇ   Auth      ‚îÇ    ‚îÇ  Billing    ‚îÇ    ‚îÇ Inventory   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ  Service    ‚îÇ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ  Service    ‚îÇ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ  Service    ‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ         ‚Üì                   ‚Üì                    ‚Üì           ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ   ‚îÇ   Orders    ‚îÇ    ‚îÇ Purchasing  ‚îÇ    ‚îÇ  Sales      ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ  Service    ‚îÇ    ‚îÇ  Service    ‚îÇ    ‚îÇ  Service    ‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ         ‚Üì                   ‚Üì                    ‚Üì           ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ              All services communicate via HTTP/2             ‚îÇ
‚îÇ            with Managed Identity authentication              ‚îÇ
‚îÇ              (Dapr service-to-service calls)                 ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre>
<p><strong>Communication Pattern:</strong></p>
<pre><code>Service A ‚Üí Service B

1. Service A gets own MI token (implicit)
2. Service A calls Service B at https://service-b
3. Service B validates caller's MI
4. Communication established (mTLS)
5. Response returned
</code></pre>
<hr>
<h2 id="deployment-topology">Deployment Topology</h2>
<h3 id="resource-group-organization">Resource Group Organization</h3>
<pre><code>rg-{environment}
‚îú‚îÄ core/
‚îÇ  ‚îú‚îÄ Container Apps Environment
‚îÇ  ‚îú‚îÄ Container Registry
‚îÇ  ‚îú‚îÄ Log Analytics Workspace
‚îÇ  ‚îî‚îÄ Storage Account (file shares)
‚îÇ
‚îú‚îÄ database/
‚îÇ  ‚îú‚îÄ SQL Server
‚îÇ  ‚îÇ  ‚îú‚îÄ AuthDB
‚îÇ  ‚îÇ  ‚îú‚îÄ BillingDB
‚îÇ  ‚îÇ  ‚îú‚îÄ InventoryDB
‚îÇ  ‚îÇ  ‚îú‚îÄ OrdersDB
‚îÇ  ‚îÇ  ‚îú‚îÄ PurchasingDB
‚îÇ  ‚îÇ  ‚îî‚îÄ SalesDB
‚îÇ  ‚îî‚îÄ Redis Cache
‚îÇ
‚îú‚îÄ security/
‚îÇ  ‚îú‚îÄ Key Vault
‚îÇ  ‚îî‚îÄ Managed Identities (7 + 1)
‚îÇ
‚îú‚îÄ configuration/
‚îÇ  ‚îú‚îÄ App Configuration
‚îÇ  ‚îî‚îÄ Application Insights
‚îÇ
‚îî‚îÄ services/
   ‚îú‚îÄ API Gateway (Container App)
   ‚îú‚îÄ Auth Service (Container App)
   ‚îú‚îÄ Billing Service (Container App)
   ‚îú‚îÄ Inventory Service (Container App)
   ‚îú‚îÄ Orders Service (Container App)
   ‚îú‚îÄ Purchasing Service (Container App)
   ‚îî‚îÄ Sales Service (Container App)
</code></pre>
<h3 id="bicep-module-hierarchy">Bicep Module Hierarchy</h3>
<pre><code>main.bicep (Orchestrator)
‚îú‚îÄ resources.bicep (shared resources)
‚îú‚îÄ core/
‚îÇ  ‚îú‚îÄ host/container-app.bicep
‚îÇ  ‚îú‚îÄ database/
‚îÇ  ‚îÇ  ‚îú‚îÄ redis.bicep
‚îÇ  ‚îÇ  ‚îî‚îÄ sql-server.bicep
‚îÇ  ‚îú‚îÄ security/
‚îÇ  ‚îÇ  ‚îú‚îÄ keyvault-secrets.bicep
‚îÇ  ‚îÇ  ‚îî‚îÄ keyvault-rbac.bicep
‚îÇ  ‚îî‚îÄ configuration/
‚îÇ     ‚îú‚îÄ app-configuration.bicep
‚îÇ     ‚îî‚îÄ appconfig-rbac.bicep
‚îú‚îÄ services/ (1 per microservice)
‚îÇ  ‚îú‚îÄ auth-service.bicep
‚îÇ  ‚îú‚îÄ billing-service.bicep
‚îÇ  ‚îú‚îÄ inventory-service.bicep
‚îÇ  ‚îú‚îÄ orders-service.bicep
‚îÇ  ‚îú‚îÄ purchasing-service.bicep
‚îÇ  ‚îú‚îÄ sales-service.bicep
‚îÇ  ‚îú‚îÄ api-gateway.bicep
‚îÇ  ‚îî‚îÄ container-app-service.bicep (shared template)
‚îî‚îÄ Infrastructure-as-Code modules
   ‚îú‚îÄ myapp-sqlserver/
   ‚îú‚îÄ myapp-sqlserver-roles/
   ‚îú‚îÄ MyApp-ApplicationInsights/
   ‚îî‚îÄ MyApp-LogAnalyticsWorkspace/
</code></pre>
<hr>
<h2 id="service-communication">Service Communication</h2>
<h3 id="intra-service-communication-pattern">Intra-Service Communication Pattern</h3>
<pre><code class="lang-mermaid">graph LR
    subgraph &quot;Caller&quot;
        A[&quot;Service A&lt;br/&gt;Managed Identity&quot;]
    end
    
    subgraph &quot;Azure&quot;
        DAPR[&quot;Dapr Sidecar&lt;br/&gt;(Service Invocation)&quot;]
        MTLS[&quot;mTLS Connection&quot;]
    end
    
    subgraph &quot;Callee&quot;
        B[&quot;Service B&lt;br/&gt;Managed Identity&quot;]
    end
    
    A --&gt;|1. Invoke&lt;br/&gt;http://service-b| DAPR
    DAPR --&gt;|2. Check MI&lt;br/&gt;credential| DAPR
    DAPR --&gt;|3. Establish&lt;br/&gt;mTLS| MTLS
    MTLS --&gt;|4. Forward&lt;br/&gt;request| B
    B --&gt;|5. Process&lt;br/&gt;request| B
    B --&gt;|6. Return&lt;br/&gt;response| MTLS
    MTLS --&gt;|7. Forward&lt;br/&gt;response| DAPR
    DAPR --&gt;|8. Return&lt;br/&gt;to caller| A
    
    style A fill:#87CEEB
    style B fill:#87CEEB
    style DAPR fill:#90EE90
    style MTLS fill:#FFD700
</code></pre>
<h3 id="external-communication-pattern">External Communication Pattern</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Internet (Public)                         ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Client (Web/Mobile)                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ HTTPS TLS 1.2+                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Certificate validation                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Header: Authorization: Bearer {JWT}      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Azure Container Apps                      ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  API Gateway (External Ingress Enabled)      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Ocelot (API Gateway middleware)          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ HTTPS only                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Rate limiting                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ JWT validation                           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                        ‚Üì                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Internal Services (Private Network)         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Auth Service                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Billing Service                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Inventory Service                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Orders Service                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Purchasing Service                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Sales Service                            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Azure Data Services                       ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îú‚îÄ SQL Server (Private endpoint)                  ‚îÇ
‚îÇ  ‚îú‚îÄ Redis Cache (Private endpoint)                ‚îÇ
‚îÇ  ‚îú‚îÄ Key Vault (Firewall rules)                    ‚îÇ
‚îÇ  ‚îî‚îÄ App Configuration (Firewall rules)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre>
<hr>
<h2 id="scaling--performance">Scaling &amp; Performance</h2>
<h3 id="auto-scaling-configuration">Auto-Scaling Configuration</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        Service Auto-Scaling Rules           ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Each Container App:                        ‚îÇ
‚îÇ  ‚îú‚îÄ Min Replicas: 1                        ‚îÇ
‚îÇ  ‚îú‚îÄ Max Replicas: 10                       ‚îÇ
‚îÇ  ‚îú‚îÄ CPU per instance: 0.5 cores            ‚îÇ
‚îÇ  ‚îú‚îÄ Memory per instance: 1 GB              ‚îÇ
‚îÇ  ‚îÇ                                         ‚îÇ
‚îÇ  ‚îî‚îÄ Scaling Rules:                         ‚îÇ
‚îÇ     ‚îú‚îÄ HTTP Requests: Scale on 70% CPU    ‚îÇ
‚îÇ     ‚îú‚îÄ Concurrency: Scale on connections  ‚îÇ
‚îÇ     ‚îî‚îÄ Queue Length: Scale on queue depth ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Scaling Behavior:                         ‚îÇ
‚îÇ  ‚îú‚îÄ Scale-up: +2 replicas (60 seconds)    ‚îÇ
‚îÇ  ‚îú‚îÄ Scale-down: -1 replica (300 seconds)  ‚îÇ
‚îÇ  ‚îî‚îÄ Max scale rate: +100% replicas/min    ‚îÇ
‚îÇ                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre>
<h3 id="performance-optimization">Performance Optimization</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Optimization</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Redis Cache</strong></td>
<td>- allkeys-lru eviction policy<br>- 5-minute TTL for query results<br>- Connection pooling</td>
</tr>
<tr>
<td><strong>SQL Server</strong></td>
<td>- Query Store enabled<br>- Automatic statistics<br>- TempDB optimization<br>- Index maintenance</td>
</tr>
<tr>
<td><strong>App Config</strong></td>
<td>- 30-second cache in clients<br>- Key Vault reference caching<br>- Batch key reads</td>
</tr>
<tr>
<td><strong>Services</strong></td>
<td>- Connection pooling to DB<br>- Redis distributed caching<br>- Async/await patterns<br>- Dapr pub/sub for events</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="disaster-recovery">Disaster Recovery</h2>
<h3 id="backup-strategy">Backup Strategy</h3>
<pre><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            Backup Strategy                      ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Database Backups (SQL Server)                  ‚îÇ
‚îÇ  ‚îú‚îÄ Full Backup: Daily (automatic)              ‚îÇ
‚îÇ  ‚îú‚îÄ Differential: Every 4 hours                 ‚îÇ
‚îÇ  ‚îú‚îÄ Transaction Log: Every 15 minutes           ‚îÇ
‚îÇ  ‚îú‚îÄ Retention: 35 days                          ‚îÇ
‚îÇ  ‚îî‚îÄ Recovery: RPO &lt; 15 min, RTO &lt; 1 hour       ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Configuration Backups                          ‚îÇ
‚îÇ  ‚îú‚îÄ App Configuration: Version control (Git)    ‚îÇ
‚îÇ  ‚îú‚îÄ Bicep templates: Git repository             ‚îÇ
‚îÇ  ‚îú‚îÄ Key Vault: Enabled for recovery             ‚îÇ
‚îÇ  ‚îî‚îÄ Secrets: Not backed up (regenerate)         ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Container Images                               ‚îÇ
‚îÇ  ‚îú‚îÄ ACR: Geo-replication ready                  ‚îÇ
‚îÇ  ‚îú‚îÄ Retention: Latest 10 versions               ‚îÇ
‚îÇ  ‚îî‚îÄ Scan: Continuous vulnerability scan         ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre>
<h3 id="failover--recovery">Failover &amp; Recovery</h3>
<pre><code class="lang-mermaid">graph TD
    A[&quot;Failure Detected&lt;br/&gt;(Health check)&quot;] --&gt; B[&quot;Auto-scale triggered&quot;]
    B --&gt; C{&quot;Failure Type?&quot;}
    
    C --&gt;|Pod Crash| D[&quot;Orchestrator spins&lt;br/&gt;new replica&quot;]
    D --&gt; E[&quot;Service restored&lt;br/&gt;on new instance&quot;]
    
    C --&gt;|Zone Failure| F[&quot;Load balanced to&lt;br/&gt;other zones&quot;]
    F --&gt; E
    
    C --&gt;|Service Degradation| G[&quot;Alert sent to&lt;br/&gt;Operations&quot;]
    G --&gt; H[&quot;Manual intervention&lt;br/&gt;if needed&quot;]
    
    C --&gt;|Data Corruption| I[&quot;Restore from&lt;br/&gt;backup&quot;]
    I --&gt; J[&quot;Point-in-time&lt;br/&gt;recovery&quot;]
    J --&gt; K[&quot;Services resume&quot;]
    
    E --&gt; L[&quot;Health check passes&quot;]
    K --&gt; L
    L --&gt; M[&quot;Traffic restored&quot;]
</code></pre>
<hr>
<h2 id="implementation-details">Implementation Details</h2>
<h3 id="bicep-parameter-inputs">Bicep Parameter Inputs</h3>
<pre><code class="lang-bicep">// Required Parameters
param environmentName string              // e.g., &quot;prod&quot;
param location string                     // e.g., &quot;eastus&quot;

// Secure Parameters (generated)
@secure() param cache_password string     // Redis authentication
@secure() param password string           // SQL admin password
@secure() param jwtSecretKey string       // JWT signing key

// Configuration Parameters
param jwtIssuer string                    // JWT token issuer
param jwtAudience string                  // JWT token audience
param frontendOrigin string                // CORS origins
param aspnetcoreEnvironment string        // Dev/Staging/Prod
</code></pre>
<h3 id="container-app-configuration">Container App Configuration</h3>
<pre><code class="lang-bicep">CPU:              0.5 cores
Memory:           1 GB
Replicas:         Min: 1, Max: 10
Environment:      Container Apps Environment
Ingress:          Enabled/Disabled per service
External:         Enabled only for API Gateway
Dapr:             Enabled for service-to-service
Service Invocation: Enabled (mTLS)
State Management: Redis-backed
</code></pre>
<h3 id="environment-variables-per-service">Environment Variables Per Service</h3>
<pre><code class="lang-bicep">Common to All:
‚îú‚îÄ ASPNETCORE_ENVIRONMENT
‚îú‚îÄ ApplicationInsights__InstrumentationKey
‚îú‚îÄ Logging__LogLevel__Default
‚îî‚îÄ OpenTelemetry__Enabled

Service-Specific:
‚îú‚îÄ Database connection (from App Config)
‚îú‚îÄ Cache connection (from App Config)
‚îú‚îÄ JWT configuration (from App Config)
‚îú‚îÄ Service-specific settings
‚îî‚îÄ Feature flags (from App Config)
</code></pre>
<hr>
<h2 id="security-best-practices-implemented">Security Best Practices Implemented</h2>
<h3 id="-authentication--authorization">‚úÖ Authentication &amp; Authorization</h3>
<ul>
<li>[x] Managed Identities (no passwords)</li>
<li>[x] Azure RBAC for resource access</li>
<li>[x] JWT tokens for service-to-service calls</li>
<li>[x] TLS 1.2+ enforcement</li>
<li>[x] mTLS between services (Dapr)</li>
</ul>
<h3 id="-secret-management">‚úÖ Secret Management</h3>
<ul>
<li>[x] Azure Key Vault for all secrets</li>
<li>[x] No secrets in code or config files</li>
<li>[x] Centralized access via App Configuration</li>
<li>[x] Secrets never logged</li>
<li>[x] Audit logging for all access</li>
</ul>
<h3 id="-network-security">‚úÖ Network Security</h3>
<ul>
<li>[x] Firewall rules on Key Vault</li>
<li>[x] Private endpoints (optional)</li>
<li>[x] Network policies (NSGs)</li>
<li>[x] DDoS protection (standard)</li>
<li>[x] Service-to-service mTLS</li>
</ul>
<h3 id="-data-protection">‚úÖ Data Protection</h3>
<ul>
<li>[x] Encryption in transit (TLS)</li>
<li>[x] Encryption at rest (managed keys)</li>
<li>[x] Database encryption (TDE)</li>
<li>[x] Redis encryption (optional)</li>
<li>[x] Key rotation (manual)</li>
</ul>
<h3 id="-monitoring--auditing">‚úÖ Monitoring &amp; Auditing</h3>
<ul>
<li>[x] All resource access logged</li>
<li>[x] Key Vault access audit trail</li>
<li>[x] Service logs to Log Analytics</li>
<li>[x] Application Insights tracing</li>
<li>[x] Alerts for suspicious activity</li>
</ul>
<hr>
<h2 id="deployment-process">Deployment Process</h2>
<h3 id="prerequisites">Prerequisites</h3>
<pre><code class="lang-powershell"># Azure CLI
az --version  # 2.50+

# Bicep
az bicep version

# PowerShell
$PSVersionTable.PSVersion  # 5.1+

# Authenticated to Azure
az account show
</code></pre>
<h3 id="deployment-steps">Deployment Steps</h3>
<pre><code class="lang-powershell"># 1. Generate secure parameters
$jwtSecret = [Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(48))
$cachePassword = [Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))
$sqlPassword = &quot;P@ssw0rd!Complex&quot; # 8-128 chars, special chars required

# 2. Create parameters file
$params = @{
    environmentName = &quot;prod&quot;
    location = &quot;eastus&quot;
    jwtSecretKey = $jwtSecret
    cache_password = $cachePassword
    password = $sqlPassword
}

# 3. Validate Bicep
az bicep build --file main.bicep

# 4. Validate deployment
az deployment sub validate `
  --template-file main.bicep `
  --parameters $params `
  --location eastus

# 5. Deploy infrastructure
az deployment sub create `
  --template-file main.bicep `
  --parameters $params `
  --name &quot;erp-deployment-$(Get-Date -Format 'yyyyMMdd-HHmmss')&quot; `
  --location eastus
</code></pre>
<hr>
<h2 id="appendix-quick-reference">Appendix: Quick Reference</h2>
<h3 id="important-urls">Important URLs</h3>
<table>
<thead>
<tr>
<th>Service</th>
<th>URL Pattern</th>
<th>Access</th>
</tr>
</thead>
<tbody>
<tr>
<td>API Gateway</td>
<td><code>https://{fqdn}.${location}.azurecontainerapps.io</code></td>
<td>External</td>
</tr>
<tr>
<td>Auth Service</td>
<td><code>https://auth-service.${domain}</code></td>
<td>Internal</td>
</tr>
<tr>
<td>App Insights</td>
<td><code>https://portal.azure.com</code></td>
<td>Azure Portal</td>
</tr>
<tr>
<td>Key Vault</td>
<td><code>https://{vault-name}.vault.azure.net</code></td>
<td>Azure Portal</td>
</tr>
<tr>
<td>App Config</td>
<td><code>https://{store-name}.azconfig.io</code></td>
<td>Azure Portal</td>
</tr>
</tbody>
</table>
<h3 id="useful-azure-cli-commands">Useful Azure CLI Commands</h3>
<pre><code class="lang-powershell"># List all services
az containerapp list -g rg-{environment} -o table

# View logs
az containerapp logs show -g rg-{environment} -n {service-name}

# Scale manually
az containerapp update -g rg-{environment} -n {service-name} `
  --min-replicas 2 --max-replicas 20

# Get secrets from Key Vault
az keyvault secret show --vault-name {vault-name} --name {secret-name}

# View configuration
az appconfig kv list --name {config-store-name}
</code></pre>
<h3 id="monitoring-queries-kql">Monitoring Queries (KQL)</h3>
<pre><code class="lang-kusto">// Service errors (last 24h)
traces
| where severity == &quot;Error&quot;
| where timestamp &gt; ago(24h)
| summarize Count = count() by name

// API response times
customMetrics
| where name == &quot;RequestDuration&quot;
| summarize AvgDuration = avg(value) by bin(timestamp, 5m)

// Service dependencies
dependencies
| summarize by type, name
| sort by name
</code></pre>
<hr>
<p><strong>Document Version:</strong> 1.0<br>
<strong>Last Updated:</strong> 2024-10-27<br>
<strong>Status:</strong> ‚úÖ Complete - Production Ready</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Ozymandros/ERP.Microservices/blob/main/docs/architecture/ARCHITECTURE_DOCUMENTATION.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          ERP Microservices - A cloud-native ERP system built with .NET 9
        </div>
      </div>
    </footer>
  </body>
</html>
