name: Build & Deploy ERP Services to Azure

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  AZURE_ENV_NAME: "dev"
  AZURE_LOCATION: "westeurope"

jobs:
  provision-infrastructure:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Azure login (Federated)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd to use Azure CLI credentials
        run: |
          echo "Configuring azd to use Azure CLI credentials..."
          # azd will use Azure CLI credentials when AZURE_CLIENT_ID is set
          export AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}
          export AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}
          export AZURE_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}

          # Verify Azure CLI is authenticated
          az account show || {
            echo "ERROR: Azure CLI is not authenticated"
            exit 1
          }

          # Configure azd to use Azure CLI credentials
          azd config set auth.useAzCliAuth true

      - name: Install and Initialize Dapr CLI
        run: |
          wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash
          mkdir -p ~/.dapr/bin
          cp /usr/local/bin/dapr ~/.dapr/bin/dapr
          chmod +x ~/.dapr/bin/dapr
          ~/.dapr/bin/dapr init --slim
          ~/.dapr/bin/dapr --version

      - name: Provision Infrastructure
        env:
          AZURE_ENV_NAME: ${{ env.AZURE_ENV_NAME }}
          AZURE_LOCATION: ${{ env.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          echo "Provisioning infrastructure..."
          azd provision --no-prompt

      - name: Get Registry Name from azd outputs
        id: registry
        env:
          AZURE_ENV_NAME: ${{ env.AZURE_ENV_NAME }}
        run: |
          echo "Getting registry name from azd outputs..."

          # Capture JSON output and check if azd show succeeded
          AZD_OUTPUT=$(azd show --output json --environment $AZURE_ENV_NAME 2>&1)
          AZD_EXIT_CODE=$?

          if [ $AZD_EXIT_CODE -ne 0 ]; then
            echo "ERROR: azd show failed with exit code $AZD_EXIT_CODE"
            echo "Output: $AZD_OUTPUT"
            echo ""
            echo "This indicates the infrastructure provision failed or the environment does not exist."
            exit 1
          fi

          # Extract registry name from JSON output
          REGISTRY_NAME=$(echo "$AZD_OUTPUT" | jq -r '.outputs.AZURE_CONTAINER_REGISTRY_NAME.value // empty')

          if [ -z "$REGISTRY_NAME" ] || [ "$REGISTRY_NAME" == "null" ]; then
            echo "ERROR: Registry name not found in azd outputs!"
            echo "This indicates the infrastructure provision did not create the registry correctly."
            echo ""
            echo "Debugging information:"
            echo "Environment: $AZURE_ENV_NAME"
            echo "Available outputs:"
            echo "$AZD_OUTPUT" | jq '.outputs // {}'
            exit 1
          fi

          echo "✓ Registry name obtained: $REGISTRY_NAME"
          echo "registry_name=$REGISTRY_NAME" >> $GITHUB_OUTPUT

    outputs:
      registry_name: ${{ steps.registry.outputs.registry_name }}

  build-and-push-images:
    name: Build Docker Images
    needs: provision-infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login (Federated)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Use Registry Name from Provision Job
        run: |
          REGISTRY_NAME="${{ needs.provision-infrastructure.outputs.registry_name }}"
          if [ -z "$REGISTRY_NAME" ]; then
            echo "ERROR: Registry name not available from provision job!"
            exit 1
          fi
          echo "✓ Using registry: $REGISTRY_NAME"
          echo "REGISTRY_NAME=$REGISTRY_NAME" >> $GITHUB_ENV

      - name: Login to ACR
        run: az acr login --name ${{ needs.provision-infrastructure.outputs.registry_name }}

      # Build and push shared base image FIRST (required by Inventory, Billing, Orders, Purchasing, Sales)
      - name: Build and push shared base image
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY_NAME="${{ needs.provision-infrastructure.outputs.registry_name }}"
          echo "Building shared base image with tag: $IMAGE_TAG"

          az acr build \
            --registry $REGISTRY_NAME \
            --image "myapp-microservices-base:$IMAGE_TAG" \
            --image "myapp-microservices-base:10.0" \
            --image "myapp-microservices-base:latest" \
            --file docker/microservices-base.Dockerfile \
            .

          # Verify base image was built and pushed successfully
          echo "Verifying base image exists in registry..."
          az acr repository show --name $REGISTRY_NAME --repository myapp-microservices-base || {
            echo "ERROR: Base image repository not found in registry after build!"
            exit 1
          }

          echo "Checking base image tags..."
          az acr repository show-tags --name $REGISTRY_NAME --repository myapp-microservices-base --output table

          # Verify specific tags exist
          echo "Verifying required tags exist..."
          TAGS=$(az acr repository show-tags --name $REGISTRY_NAME --repository myapp-microservices-base --output tsv)
          if [[ ! "$TAGS" =~ "$IMAGE_TAG" ]]; then
            echo "WARNING: Tag $IMAGE_TAG not found, but continuing..."
          fi
          if [[ ! "$TAGS" =~ "10.0" ]]; then
            echo "ERROR: Tag 10.0 not found - this is required!"
            exit 1
          fi
          if [[ ! "$TAGS" =~ "latest" ]]; then
            echo "ERROR: Tag latest not found - this is required!"
            exit 1
          fi

          echo "✓ Base image verified in registry with all required tags"

      # Build and push all service images
      - name: Build and push service images to ACR
        run: |
          # Define services to build (path relative to src/, image name)
          declare -a SERVICES=(
              "MyApp.Auth/MyApp.Auth.API:auth-service"
              "MyApp.Billing/MyApp.Billing.API:billing-service"
              "MyApp.Inventory/MyApp.Inventory.API:inventory-service"
              "MyApp.Orders/MyApp.Orders.API:orders-service"
              "MyApp.Purchasing/MyApp.Purchasing.API:purchasing-service"
              "MyApp.Sales/MyApp.Sales.API:sales-service"
              "ErpApiGateway:erp-api-gateway"
          )

          # Get Git commit hash for image tag
          IMAGE_TAG=${GITHUB_SHA::7}
          REGISTRY_NAME="${{ needs.provision-infrastructure.outputs.registry_name }}"

          echo "Building service images with tag: $IMAGE_TAG"

          # Registry prefix for base image (services that use shared base image)
          REGISTRY_PREFIX="${REGISTRY_NAME}.azurecr.io/"

          for SERVICE in "${SERVICES[@]}"; do
              IFS=':' read -r SERVICE_PATH IMAGE_NAME <<< "$SERVICE"
              echo "Building: $IMAGE_NAME from src/$SERVICE_PATH"
              
              # Check if this service uses the shared base image (all except auth-service and erp-api-gateway)
              if [[ "$IMAGE_NAME" != "auth-service" && "$IMAGE_NAME" != "erp-api-gateway" ]]; then
                  # Pass registry prefix as build arg for base image resolution
                  # Use root context (.) and add src/ prefix to Dockerfile path
                  az acr build \
                      --registry $REGISTRY_NAME \
                      --image "$IMAGE_NAME:$IMAGE_TAG" \
                      --image "$IMAGE_NAME:latest" \
                      --file "src/$SERVICE_PATH/Dockerfile" \
                      --build-arg BASE_IMAGE_REGISTRY="$REGISTRY_PREFIX" \
                      .
              else
                  # Auth and Gateway don't use shared base image
                  # Use root context (.) and add src/ prefix to Dockerfile path
                  az acr build \
                      --registry $REGISTRY_NAME \
                      --image "$IMAGE_NAME:$IMAGE_TAG" \
                      --image "$IMAGE_NAME:latest" \
                      --file "src/$SERVICE_PATH/Dockerfile" \
                      .
              fi
          done

      - name: Verify images in ACR
        run: |
          REGISTRY_NAME="${{ needs.provision-infrastructure.outputs.registry_name }}"

          echo "=== All Images in ACR ==="
          az acr repository list --name $REGISTRY_NAME --output table

          echo ""
          echo "=== Base Image Tags ==="
          az acr repository show-tags --name $REGISTRY_NAME --repository myapp-microservices-base --output table || echo "Base image not found"

          echo ""
          echo "=== Service Image Tags ==="
          for IMAGE in auth-service billing-service inventory-service orders-service purchasing-service sales-service erp-api-gateway; do
              echo "Tags for $IMAGE:"
              az acr repository show-tags --name $REGISTRY_NAME --repository $IMAGE --output table --top 3 || echo "  Image $IMAGE not found"
              echo ""
          done

          echo "=== Build Summary ==="
          IMAGE_TAG=${GITHUB_SHA::7}
          echo "Built images with tag: $IMAGE_TAG"
          echo "- myapp-microservices-base:$IMAGE_TAG"
          echo "- auth-service:$IMAGE_TAG"
          echo "- billing-service:$IMAGE_TAG"
          echo "- inventory-service:$IMAGE_TAG"
          echo "- orders-service:$IMAGE_TAG"
          echo "- purchasing-service:$IMAGE_TAG"
          echo "- sales-service:$IMAGE_TAG"
          echo "- erp-api-gateway:$IMAGE_TAG"

  deploy-to-azure:
    name: Deploy Application
    needs: build-and-push-images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure Developer CLI
        uses: Azure/setup-azd@v2

      - name: Azure login (Federated)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd to use Azure CLI credentials
        run: |
          echo "Configuring azd to use Azure CLI credentials..."
          # Verify Azure CLI is authenticated
          az account show || {
            echo "ERROR: Azure CLI is not authenticated"
            exit 1
          }
          # Configure azd to use Azure CLI credentials
          azd config set auth.useAzCliAuth true

      - name: Set up dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Deploy Application
        env:
          AZURE_ENV_NAME: ${{ env.AZURE_ENV_NAME }}
          AZURE_LOCATION: ${{ env.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          # Use short commit hash to match image tags (first 7 characters)
          export IMAGE_TAG=${GITHUB_SHA::7}
          echo "Deploying with image tag: $IMAGE_TAG"
          azd deploy --no-prompt

  verify-deployment:
    name: Verify Deployment
    needs: deploy-to-azure
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Azure login (Federated)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check Container Apps status
        run: |
          RG_NAME="rg-myapp-${{ env.AZURE_ENV_NAME }}-core"

          echo "Checking Container Apps health..."
          az containerapp list --resource-group "$RG_NAME" --output table

          echo ""
          echo "Checking revision status..."
          for APP in auth-service billing-service inventory-service orders-service purchasing-service sales-service api-gateway; do
              echo ""
              echo "App: myapp-${{ env.AZURE_ENV_NAME }}-$APP"
              az containerapp show --name "myapp-${{ env.AZURE_ENV_NAME }}-$APP" \
                  --resource-group "$RG_NAME" \
                  --query "properties.latestRevisionFqdn" -o tsv || echo "Not found"
          done

      - name: Run smoke tests
        run: |
          echo "✓ Deployment verified successfully"
