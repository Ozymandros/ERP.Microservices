# BuildKit optimization: Enable faster builds with cache mounts
x-buildkit: &buildkit
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

x-redis-password: &redis-password ${REDIS_PASSWORD:-Redis@Secure123!}

x-api-env: &api-env
  ASPNETCORE_ENVIRONMENT: Development
  ASPNETCORE_URLS: http://+:8080
  FRONTEND_ORIGIN: ${FRONTEND_ORIGIN:-http://localhost:3000;http://localhost:5000}
  Jwt__SecretKey: ${JWT_SECRET:-una_clau_molt_llarga_i_super_ultra_secreta_01234566789}
  Jwt__Issuer: ${JWT_ISSUER:-MyApp.Auth}
  Jwt__Audience: ${JWT_AUDIENCE:-MyApp.All}
  ConnectionStrings__cache: redis:6379,password=${REDIS_PASSWORD:-Redis@Secure123!},defaultDatabase=0,abortConnect=false,connectRetry=5,connectTimeout=5000,syncTimeout=5000
  Jwt__RequireHttpsMetadata: "false"
  DAPR_HTTP_PORT: "3500"
  DAPR_GRPC_PORT: "50001"

services:
  sqlserver:
      image: mcr.microsoft.com/mssql/server:2022-latest
      container_name: sqlserver
      environment:
        ACCEPT_EULA: "Y"
        MSSQL_PID: Developer
        MSSQL_SA_PASSWORD: ${SQL_PASSWORD:-P@ssw0rd12345!}
      ports:
        - "1455:1433"
      volumes:
        - sqlserver-data:/var/opt/mssql
      healthcheck:
        # THIS IS THE CORRECT COMMAND:
        test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P '${SQL_PASSWORD:-P@ssw0rd12345!}' -C -Q 'SELECT 1' || exit 1"]
        interval: 10s
        timeout: 5s
        retries: 10
      networks:
        - erp

  redis:
    image: redis:7-alpine
    container_name: redis
    command: ["redis-server", "--save", "", "--appendonly", "no", "--requirepass", *redis-password]
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - erp
    healthcheck:
      test: ["CMD", "redis-cli", "-a", *redis-password, "ping"]
      interval: 10s
      timeout: 5s
      retries: 10           # ✅ More retries (was 3)
      start_period: 120s    # ✅ 2 minutes startup time (was 30s)
    restart: unless-stopped

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD:-Redis@Secure123!}
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - erp
    restart: unless-stopped

  redis-insight:
    image: redis/redisinsight:2.66
    container_name: redis-insight
    ports:
      - "5540:5540"
    depends_on:
      - redis
    networks:
      - erp
    restart: unless-stopped

  dapr-placement:
    image: daprio/dapr:1.13.0
    container_name: dapr-placement
    command: ["./placement", "-port", "50005", "-log-level", "info"]
    ports:
      - "50005:50005"
    networks:
      - erp
    restart: unless-stopped

  # dapr-sentry:
  #   image: daprio/dapr:1.13.0
  #   container_name: dapr-sentry
  #   command: ["./sentry", "-port", "50001", "-log-level", "info"]
  #   ports:
  #     - "50001:50001"
  #   networks:
  #     - erp
  #   depends_on:
  #     - dapr-placement
  #   restart: unless-stopped

  # Build shared base image for microservices
  # IMPORTANT: This must be built BEFORE services that use myapp-microservices-base:10.0
  # Build command: docker-compose build microservices-base
  # Or build all: docker-compose build (this service will build first)
   # microservices-base:
     # build:
       # context: .
       # dockerfile: docker/microservices-base.Dockerfile
     # image: myapp-microservices-base:10.0
    # This service only builds the image; container exits immediately
     # command: ["/bin/sh", "-c", "echo 'Base image built' && sleep 1 && exit 0"]
     # restart: "no"  # Don't restart this build-only service

  erpapigateway:
    build:
      context: ./src
      dockerfile: ErpApiGateway/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: gateway
    environment:
      <<: *api-env
      Ocelot__Routes__0__DownstreamHostAndPorts__0__Host: auth-service
      Ocelot__Routes__0__DownstreamHostAndPorts__0__Port: 8080
      Ocelot__Routes__1__DownstreamHostAndPorts__0__Host: inventory-service
      Ocelot__Routes__1__DownstreamHostAndPorts__0__Port: 8080
      Ocelot__Routes__2__DownstreamHostAndPorts__0__Host: orders-service
      Ocelot__Routes__2__DownstreamHostAndPorts__0__Port: 8080
      Ocelot__Routes__3__DownstreamHostAndPorts__0__Host: sales-service
      Ocelot__Routes__3__DownstreamHostAndPorts__0__Port: 8080
      # Ocelot__Routes__4__DownstreamHostAndPorts__0__Host: billing-service
      # Ocelot__Routes__4__DownstreamHostAndPorts__0__Port: 8080
      Ocelot__Routes__5__DownstreamHostAndPorts__0__Host: purchasing-service
      Ocelot__Routes__5__DownstreamHostAndPorts__0__Port: 8080
    ports:
      - "5000:8080"
    depends_on:
      auth-service:
        condition: service_started
      # billing-service:
      #   condition: service_started
      inventory-service:
        condition: service_started
      orders-service:
        condition: service_started
      purchasing-service:
        condition: service_started
      sales-service:
        condition: service_started
    volumes:
      - ./src/ErpApiGateway/ocelot.json:/app/ocelot.json:ro
      - ./_site:/_site:ro  # Mount DocFX documentation directory
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10           # ✅ More retries (was 3)
      start_period: 120s    # ✅ 2 minutes startup time (was 30s)
    networks:
      - erp
    restart: unless-stopped

  auth-service:
    build:
      context: ./src
      dockerfile: MyApp.Auth/MyApp.Auth.API/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: auth-service
    environment:
      <<: *api-env
      ConnectionStrings__AuthDb: Server=sqlserver,1433;Database=AuthDb;User Id=sa;Password=${SQL_PASSWORD:-P@ssw0rd12345!};TrustServerCertificate=True;Encrypt=False;ConnectRetryCount=10;ConnectRetryInterval=5;
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    ports:
      - "5007:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10           # ✅ More retries (was 3)
      start_period: 120s    # ✅ 2 minutes startup time (was 30s)
    networks:
      - erp
    restart: unless-stopped

  auth-service-dapr:
    image: daprio/dapr:1.13.0
    container_name: auth-service-dapr
    depends_on:
      - auth-service
      - dapr-placement
      # - dapr-sentry
    command:
      [
        "./daprd",
        "-app-id", "auth-service",
        "-app-port", "8080",
        "-components-path", "/components",
        "-placement-host-address", "dapr-placement:50005",
        # "-sentry-address", "dapr-sentry:50001",
        "-log-level", "info"
      ]
    volumes:
      - ./deploy/dapr/components:/components:ro
    network_mode: "service:auth-service"
    restart: unless-stopped

# TODO: 
  # billing-service:
  #   build:
  #     context: ./src
  #     dockerfile: MyApp.Billing/MyApp.Billing.API/Dockerfile
  #   container_name: billing-service
  #   environment:
  #     <<: *api-env
  #     ConnectionStrings__BillingDb: Server=sqlserver,1433;Database=BillingDB;User Id=sa;Password=${SQL_PASSWORD:-P@ssw0rd12345!};TrustServerCertificate=True;Encrypt=False;
  #     #TODO: ConnectionStrings__BillingDb: Server=sqlserver,1433;Database=BillingDB;User Id=sa;Password=${SQL_PASSWORD:-P@ssw0rd12345!};TrustServerCertificate=True;Encrypt=False;ConnectRetryCount=10;ConnectRetryInterval=5;
  #   depends_on:
  #     sqlserver:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     dapr-placement:
  #       condition: service_started
  #   ports:
  #     - "5004:8080"
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 10           # ✅ More retries (was 3)
  #     start_period: 120s    # ✅ 2 minutes startup time (was 30s)
  #   networks:
  #     - erp
  #   restart: unless-stopped

  # billing-service-dapr:
  #   image: daprio/dapr:1.13.0
  #   container_name: billing-service-dapr
  #   depends_on:
  #     - billing-service
  #     - dapr-placement
  #     # - dapr-sentry
  #   command:
  #     [
  #       "./daprd",
  #       "-app-id", "billing-service",
  #       "-app-port", "8080",
  #       "-components-path", "/components",
  #       "-placement-host-address", "dapr-placement:50005",
  #       # "-sentry-address", "dapr-sentry:50001",
  #       "-log-level", "info"
  #     ]
  #   volumes:
  #     - ./deploy/dapr/components:/components:ro
  #   network_mode: "service:billing-service"
  #   restart: unless-stopped

  inventory-service:
    build:
      context: ./src
      dockerfile: MyApp.Inventory/MyApp.Inventory.API/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: inventory-service
    environment:
      <<: *api-env
      ConnectionStrings__InventoryDb: Server=sqlserver,1433;Database=InventoryDB;User Id=sa;Password=${SQL_PASSWORD:-P@ssw0rd12345!};TrustServerCertificate=True;Encrypt=False;ConnectRetryCount=10;ConnectRetryInterval=5;
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    ports:
      - "5001:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10           # ✅ More retries (was 3)
      start_period: 120s    # ✅ 2 minutes startup time (was 30s)
    networks:
      - erp
    restart: unless-stopped

  inventory-service-dapr:
    image: daprio/dapr:1.13.0
    container_name: inventory-service-dapr
    depends_on:
      - inventory-service
      - dapr-placement
      # - dapr-sentry
    command:
      [
        "./daprd",
        "-app-id", "inventory-service",
        "-app-port", "8080",
        "-components-path", "/components",
        "-placement-host-address", "dapr-placement:50005",
        # "-sentry-address", "dapr-sentry:50001",
        "-log-level", "info"
      ]
    volumes:
      - ./deploy/dapr/components:/components:ro
    network_mode: "service:inventory-service"
    restart: unless-stopped

  orders-service:
    build:
      context: ./src
      dockerfile: MyApp.Orders/MyApp.Orders.API/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: orders-service
    environment:
      <<: *api-env
      ConnectionStrings__OrdersDb: Server=sqlserver,1433;Database=OrdersDB;User Id=sa;Password=${SQL_PASSWORD:-P@ssw0rd12345!};TrustServerCertificate=True;Encrypt=False;ConnectRetryCount=10;ConnectRetryInterval=5;
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    ports:
      - "5002:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10           # ✅ More retries (was 3)
      start_period: 120s    # ✅ 2 minutes startup time (was 30s)
    networks:
      - erp
    restart: unless-stopped

  orders-service-dapr:
    image: daprio/dapr:1.13.0
    container_name: orders-service-dapr
    depends_on:
      - orders-service
      - dapr-placement
      # - dapr-sentry
    command:
      [
        "./daprd",
        "-app-id", "orders-service",
        "-app-port", "8080",
        "-components-path", "/components",
        "-placement-host-address", "dapr-placement:50005",
        # "-sentry-address", "dapr-sentry:50001",
        "-log-level", "info"
      ]
    volumes:
      - ./deploy/dapr/components:/components:ro
    network_mode: "service:orders-service"
    restart: unless-stopped

  purchasing-service:
    build:
      context: ./src
      dockerfile: MyApp.Purchasing/MyApp.Purchasing.API/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: purchasing-service
    environment:
      <<: *api-env
      ConnectionStrings__PurchasingDb: Server=sqlserver,1433;Database=PurchasingDb;User Id=sa;Password=${SQL_PASSWORD:-P@ssw0rd12345!};TrustServerCertificate=True;Encrypt=False;ConnectRetryCount=10;ConnectRetryInterval=5;
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    ports:
      - "5006:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10           # ✅ More retries (was 3)
      start_period: 120s    # ✅ 2 minutes startup time (was 30s)
    networks:
      - erp
    restart: unless-stopped

  purchasing-service-dapr:
    image: daprio/dapr:1.13.0
    container_name: purchasing-service-dapr
    depends_on:
      - purchasing-service
      - dapr-placement
      # - dapr-sentry
    command:
      [
        "./daprd",
        "-app-id", "purchasing-service",
        "-app-port", "8080",
        "-components-path", "/components",
        "-placement-host-address", "dapr-placement:50005",
        # "-sentry-address", "dapr-sentry:50001",
        "-log-level", "info"
      ]
    volumes:
      - ./deploy/dapr/components:/components:ro
    network_mode: "service:purchasing-service"
    restart: unless-stopped

  sales-service:
    build:
      context: ./src
      dockerfile: MyApp.Sales/MyApp.Sales.API/Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: sales-service
    environment:
      <<: *api-env
      ConnectionStrings__SalesDb: Server=sqlserver,1433;Database=SalesDB;User Id=sa;Password=${SQL_PASSWORD:-P@ssw0rd12345!};TrustServerCertificate=True;Encrypt=False;ConnectRetryCount=10;ConnectRetryInterval=5;
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    ports:
      - "5003:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 10           # ✅ More retries (was 3)
      start_period: 120s    # ✅ 2 minutes startup time (was 30s)
    networks:
      - erp
    restart: unless-stopped

  sales-service-dapr:
    image: daprio/dapr:1.13.0
    container_name: sales-service-dapr
    depends_on:
      - sales-service
      - dapr-placement
      # - dapr-sentry
    command:
      [
        "./daprd",
        "-app-id", "sales-service",
        "-app-port", "8080",
        "-components-path", "/components",
        "-placement-host-address", "dapr-placement:50005",
        # "-sentry-address", "dapr-sentry:50001",
        "-log-level", "info"
      ]
    volumes:
      - ./deploy/dapr/components:/components:ro
    network_mode: "service:sales-service"
    restart: unless-stopped

networks:
  erp:
    driver: bridge

volumes:
  sqlserver-data:
  redis-data:
